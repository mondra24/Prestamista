{% extends 'base.html' %}
{% load static %}
{% load currency_filters %}

{% block title %}Pr√©stamo #{{ prestamo.pk }} - Pr√©stamos{% endblock %}

{% block content %}
<div class="container-fluid px-2 px-lg-4">
    
    <!-- Header -->
    <div class="d-flex align-items-center mb-3">
        <a href="javascript:history.back()" class="btn btn-outline-secondary me-3">
            <i class="bi bi-arrow-left"></i>
        </a>
        <h1 class="h5 mb-0 flex-grow-1">Pr√©stamo #{{ prestamo.pk }}</h1>
        <span class="badge {% if prestamo.estado == 'AC' %}bg-success{% elif prestamo.estado == 'FI' %}bg-secondary{% elif prestamo.estado == 'RE' %}bg-warning{% else %}bg-danger{% endif %} fs-6">
            {{ prestamo.get_estado_display }}
        </span>
    </div>
    
    <!-- Info del pr√©stamo -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <!-- Cliente -->
            <div class="d-flex align-items-center mb-3">
                <div class="cliente-avatar me-3" style="width: 50px; height: 50px;">
                    {{ prestamo.cliente.nombre|slice:":1" }}{{ prestamo.cliente.apellido|slice:":1" }}
                </div>
                <div>
                    <a href="{% url 'core:cliente_detail' prestamo.cliente.pk %}" class="fw-semibold text-decoration-none">
                        {{ prestamo.cliente.nombre_completo }}
                    </a>
                    <small class="d-block text-muted">
                        <i class="bi bi-telephone me-1"></i>{{ prestamo.cliente.telefono }}
                    </small>
                </div>
            </div>
            
            <hr>
            
            <!-- Detalles del pr√©stamo -->
            <div class="row g-3 text-center">
                <div class="col-6 col-md-3">
                    <small class="text-muted d-block">Capital</small>
                    <strong>{{ prestamo.monto_solicitado|dinero }}</strong>
                </div>
                <div class="col-6 col-md-3">
                    <small class="text-muted d-block">Inter√©s</small>
                    <strong>{{ prestamo.tasa_interes_porcentaje }}%</strong>
                </div>
                <div class="col-6 col-md-3">
                    <small class="text-muted d-block">Total</small>
                    <strong class="text-primary">{{ prestamo.monto_total_a_pagar|dinero }}</strong>
                </div>
                <div class="col-6 col-md-3">
                    <small class="text-muted d-block">Frecuencia</small>
                    <strong>{{ prestamo.get_frecuencia_display }}</strong>
                </div>
            </div>
            
            {% if prestamo.fecha_finalizacion %}
            <div class="row g-3 text-center mt-1">
                <div class="col-6">
                    <small class="text-muted d-block">Fecha Inicio</small>
                    <strong>{{ prestamo.fecha_inicio|date:"d/m/Y" }}</strong>
                </div>
                <div class="col-6">
                    <small class="text-muted d-block">Fecha Finalizaci√≥n</small>
                    <strong class="text-info">{{ prestamo.fecha_finalizacion|date:"d/m/Y" }}</strong>
                </div>
            </div>
            {% endif %}
            
            <hr>
            
            <!-- Progreso -->
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-1">
                    <span>Progreso de pago</span>
                    <span class="fw-bold">{{ prestamo.progreso_porcentaje }}%</span>
                </div>
                <div class="progress" style="height: 10px;">
                    <div class="progress-bar" style="width: {{ prestamo.progreso_porcentaje }}%"></div>
                </div>
            </div>
            
            <div class="row g-2 text-center">
                <div class="col-4">
                    <div class="p-2 bg-success bg-opacity-10 rounded">
                        <small class="text-muted d-block">Pagado</small>
                        <strong class="text-success">{{ prestamo.monto_pagado|dinero }}</strong>
                    </div>
                </div>
                <div class="col-4">
                    <div class="p-2 bg-warning bg-opacity-10 rounded">
                        <small class="text-muted d-block">Pendiente</small>
                        <strong class="text-warning">{{ prestamo.monto_pendiente|dinero }}</strong>
                    </div>
                </div>
                <div class="col-4">
                    <div class="p-2 bg-primary bg-opacity-10 rounded">
                        <small class="text-muted d-block">Cuotas</small>
                        <strong>{{ prestamo.cuotas_pagadas }}/{{ prestamo.cuotas_pactadas }}</strong>
                    </div>
                </div>
            </div>
            
            {% if prestamo.estado == 'AC' %}
            
            {% if prestamo.es_semanal %}
            <hr>
            <div class="alert {% if prestamo.tiene_penalizacion %}alert-danger{% else %}alert-info{% endif %} mb-3">
                <h6 class="mb-2">
                    <i class="bi bi-clock-history me-1"></i> Pr√©stamo Semanal - Per√≠odo de Gracia
                </h6>
                <div class="row text-center">
                    <div class="col-6">
                        <small class="text-muted d-block">Fecha l√≠mite gracia</small>
                        <strong>{{ prestamo.fecha_limite_gracia|date:"d/m/Y" }}</strong>
                    </div>
                    <div class="col-6">
                        <small class="text-muted d-block">D√≠as de gracia</small>
                        <strong>{{ prestamo.dias_gracia }} d√≠as</strong>
                    </div>
                </div>
                {% if prestamo.tiene_penalizacion %}
                <hr class="my-2">
                <div class="text-center">
                    <span class="text-danger fw-bold">
                        <i class="bi bi-exclamation-triangle-fill me-1"></i>
                        Penalizaci√≥n activa: +{{ prestamo.penalizacion_50|dinero }} (50%)
                    </span>
                    <div class="mt-1">
                        <small class="text-muted">Total con penalizaci√≥n:</small>
                        <strong class="text-danger fs-5"> {{ prestamo.monto_con_penalizacion|dinero }}</strong>
                    </div>
                </div>
                {% else %}
                <hr class="my-2">
                <small class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    Si no paga dentro de los 7 d√≠as de gracia, se aplicar√° un 50% de penalizaci√≥n ({{ prestamo.penalizacion_50|dinero }}).
                </small>
                {% endif %}
            </div>
            {% endif %}
            
            <hr>
            <div class="d-flex gap-2">
                <a href="{% url 'core:prestamo_renovar' prestamo.pk %}" class="btn btn-warning flex-grow-1">
                    <i class="bi bi-arrow-repeat me-1"></i> Renovar
                </a>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Lista de cuotas -->
    <section>
        <h3 class="section-title">
            <i class="bi bi-list-ol"></i>
            Cuotas del Pr√©stamo
        </h3>
        
        {% for cuota in cuotas %}
        <div class="cuota-item {% if cuota.estado == 'PA' %}pagada{% elif cuota.esta_vencida %}vencida{% else %}pendiente{% endif %}">
            <div class="cuota-numero">
                <span class="numero">{{ cuota.numero_cuota }}</span>
                <span class="total">de {{ prestamo.cuotas_pactadas }}</span>
            </div>
            <div class="cuota-info">
                <div class="cuota-fecha">
                    <i class="bi bi-calendar3 me-1"></i>{{ cuota.fecha_vencimiento|date:"d M Y" }}
                </div>
                {% if cuota.estado == 'PA' %}
                    <span class="cuota-estado pagada"><i class="bi bi-check-circle-fill me-1"></i>Pagado</span>
                {% elif cuota.estado == 'PC' %}
                    <span class="cuota-estado parcial"><i class="bi bi-pie-chart-fill me-1"></i>Parcial</span>
                {% elif cuota.esta_vencida %}
                    <span class="cuota-estado vencida"><i class="bi bi-exclamation-triangle-fill me-1"></i>{{ cuota.dias_vencida }}d</span>
                {% else %}
                    <span class="cuota-estado pendiente"><i class="bi bi-clock me-1"></i>Pendiente</span>
                {% endif %}
            </div>
            <div class="cuota-monto">
                <div class="monto-principal">
                    {% if cuota.estado == 'PC' %}
                        {{ cuota.monto_restante|dinero }}
                    {% else %}
                        {{ cuota.monto_cuota|dinero }}
                    {% endif %}
                </div>
                {% if cuota.estado == 'PC' %}
                <div class="monto-restante">Resta: {{ cuota.monto_restante|dinero }}</div>
                {% endif %}
                {% if cuota.fecha_pago_real %}
                <div class="fecha-pago"><i class="bi bi-check2"></i> {{ cuota.fecha_pago_real|date:"d/m" }}</div>
                {% endif %}
                {% if cuota.cobrado_por %}
                <div class="text-muted" style="font-size:0.75rem;"><i class="bi bi-person-check"></i> {{ cuota.cobrado_por.get_full_name|default:cuota.cobrado_por.username }}</div>
                {% endif %}
                {% if cuota.historial_list %}
                <div class="mt-1">
                    <button class="btn btn-sm btn-outline-warning py-0 px-2" style="font-size:0.7rem;" type="button"
                            data-bs-toggle="collapse" data-bs-target="#historial-{{ cuota.pk }}">
                        <i class="bi bi-clock-history me-1"></i>Historial
                    </button>
                </div>
                {% endif %}
            </div>
            
            <div class="cuota-accion">
                {% if cuota.estado == 'PA' %}
                    <div class="d-flex align-items-center gap-1">
                        <div class="check-pagado">
                            <i class="bi bi-check-lg"></i>
                        </div>
                        <button class="btn-wp-talon" 
                                data-telefono="{{ prestamo.cliente.telefono }}"
                                data-cliente="{{ prestamo.cliente.nombre_completo }}"
                                data-fecha="{{ cuota.fecha_pago_real|date:'d/m/Y' }}"
                                data-cuota="{{ cuota.numero_cuota }}"
                                data-total-cuotas="{{ prestamo.cuotas_pactadas }}"
                                data-monto="{{ cuota.monto_cuota|numero_raw }}"
                                data-saldo="{{ prestamo.monto_pendiente|numero_raw }}"
                                title="Enviar tal√≥n por WhatsApp"
                                style="width:28px;height:28px;border-radius:50%;border:1px solid #25D366;background:#25D366;color:white;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:0.85rem;">
                            <i class="bi bi-whatsapp"></i>
                        </button>
                        {% if prestamo.estado != 'RE' and prestamo.estado != 'CA' %}
                        <button class="btn-anular-pago" 
                                data-cuota-id="{{ cuota.pk }}" 
                                data-cliente="{{ prestamo.cliente.nombre_completo }}"
                                data-monto="{{ cuota.monto_cuota|numero_raw }}"
                                title="Anular pago"
                                style="width:28px;height:28px;border-radius:50%;border:1px solid #dc3545;background:transparent;color:#dc3545;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:0.75rem;">
                            <i class="bi bi-x-lg"></i>
                        </button>
                        {% endif %}
                    </div>
                {% elif prestamo.estado == 'AC' and prestamo.cobrador == user %}
                    <div class="d-flex gap-1">
                        {% if cuota.estado == 'PC' %}
                        <button class="btn-anular-pago" 
                                data-cuota-id="{{ cuota.pk }}" 
                                data-cliente="{{ prestamo.cliente.nombre_completo }}"
                                data-monto="{{ cuota.monto_pagado|numero_raw }}"
                                title="Anular pago parcial"
                                style="width:32px;height:32px;border-radius:50%;border:1px solid #dc3545;background:transparent;color:#dc3545;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:0.75rem;">
                            <i class="bi bi-x-lg"></i>
                        </button>
                        {% endif %}    <button class="btn-editar-cobro" style="width:32px;height:32px;border-radius:50%;border:1px solid var(--border-color);background:var(--bg-card);color:var(--text-secondary);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:0.85rem;"
                                data-cuota-id="{{ cuota.pk }}"
                                data-monto="{{ cuota.monto_restante|numero_raw }}"
                                data-mora="0"
                                data-cliente="{{ prestamo.cliente.nombre_completo }}"
                                data-dias-vencida="{% if cuota.esta_vencida %}{{ cuota.dias_vencida }}{% else %}0{% endif %}"
                                data-fecha="{{ cuota.fecha_vencimiento|date:'Y-m-d' }}"
                                title="Cobro personalizado">
                            <i class="bi bi-pencil-square"></i>
                        </button>
                        <button class="btn-cobrar" data-cuota-id="{{ cuota.pk }}" data-cliente="{{ prestamo.cliente.nombre_completo }}" data-monto="{{ cuota.monto_restante|numero_raw }}" title="Cobrar completo" style="width:32px;height:32px;font-size:0.85rem;">
                            <i class="bi bi-check-lg"></i>
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
        {% if cuota.historial_list %}
        <div class="collapse" id="historial-{{ cuota.pk }}">
            <div class="card card-body border-warning mb-2 p-2" style="font-size:0.8rem; background: var(--bg-card);">
                <h6 class="mb-2 text-warning"><i class="bi bi-clock-history me-1"></i>Historial de Modificaciones</h6>
                {% for h in cuota.historial_list %}
                <div class="d-flex justify-content-between align-items-start border-bottom py-1">
                    <div>
                        <span class="badge {% if h.tipo_modificacion == 'PP' %}bg-warning text-dark{% elif h.tipo_modificacion == 'PA' %}bg-success{% elif h.tipo_modificacion == 'TR' %}bg-info text-dark{% elif h.tipo_modificacion == 'CE' %}bg-primary{% elif h.tipo_modificacion == 'MR' %}bg-secondary{% elif h.tipo_modificacion == 'AN' %}bg-danger{% endif %} me-1">
                            {{ h.get_tipo_modificacion_display }}
                        </span>
                        <span>{{ h.resumen }}</span>
                        {% if h.metodo_pago %}
                        <span class="text-muted ms-1">({{ h.get_metodo_pago_display }})</span>
                        {% endif %}
                    </div>
                    <div class="text-muted text-end" style="white-space:nowrap;">
                        {{ h.fecha_modificacion|date:"d/m/Y H:i" }}
                        {% if h.usuario %}<br><small>{{ h.usuario.get_full_name|default:h.usuario.username }}</small>{% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </section>
    
    <!-- Notas -->
    {% if prestamo.notas %}
    <section class="mt-4">
        <h3 class="section-title">
            <i class="bi bi-sticky"></i>
            Notas
        </h3>
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                {{ prestamo.notas|linebreaks }}
            </div>
        </div>
    </section>
    {% endif %}
    
</div>

{% csrf_token %}

<!-- Modal para cobro personalizado -->
<div class="modal fade" id="modal-pago-parcial" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white py-3">
                <h5 class="modal-title">
                    <i class="bi bi-receipt me-2"></i>Cobro Personalizado
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="pago-cuota-id">
                <input type="hidden" id="pago-monto-max">
                
                <!-- Info del cliente -->
                <div class="text-center mb-3 pb-2 border-bottom">
                    <h6 class="mb-1" id="pago-cliente-nombre">Cliente</h6>
                    <div class="d-flex justify-content-center gap-3 small">
                        <span>Cuota: <strong id="pago-monto-max-label" class="text-primary">$0</strong></span>
                        <span>Fecha: <strong id="pago-fecha-cuota" class="text-primary">--</strong></span>
                    </div>
                    <div id="info-mora-container" class="mt-2" style="display: none;">
                        <span class="badge bg-danger"><i class="bi bi-exclamation-triangle me-1"></i>Vencida hace <span id="pago-dias-vencida">0</span> d√≠as</span>
                    </div>
                </div>
                
                <!-- Monto a cobrar -->
                <div class="mb-3">
                    <label class="form-label fw-semibold small">Monto a cobrar:</label>
                    <input type="text" class="form-control form-control-lg text-center" id="pago-monto" 
                           inputmode="numeric" placeholder="0"
                           oninput="formatearInputMonto(this); calcularResumenPago(); calcularInteresDesdeporcentaje(); validarMontosMixtos()">
                </div>
                
                <!-- Calculador de Inter√©s -->
                <div class="card bg-light mb-3">
                    <div class="card-body py-2">
                        <label class="form-label fw-semibold small mb-2">
                            <i class="bi bi-percent me-1"></i>Calcular Inter√©s por Mora
                        </label>
                        <div class="row g-2 align-items-end">
                            <div class="col-5">
                                <label class="form-label small mb-1">% Diario:</label>
                                <input type="number" step="0.01" class="form-control form-control-sm text-center" 
                                       id="pago-porcentaje-input" value="{{ config_mora.porcentaje_diario|default:'0.5' }}"
                                       oninput="calcularInteresDesdeporcentaje()">
                            </div>
                            <div class="col-4">
                                <label class="form-label small mb-1">D√≠as:</label>
                                <input type="number" class="form-control form-control-sm text-center" 
                                       id="pago-dias-mora-input" value="0"
                                       oninput="calcularInteresDesdeporcentaje()">
                            </div>
                            <div class="col-3">
                                <button type="button" class="btn btn-primary btn-sm w-100" onclick="aplicarInteresCalculado()">
                                    <i class="bi bi-arrow-down"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mt-2 text-center" id="interes-calculado-container">
                            <small class="text-muted">Inter√©s calculado:</small>
                            <div class="fw-bold text-warning fs-5" id="interes-calculado-preview">$0</div>
                        </div>
                    </div>
                </div>
                
                <!-- Inter√©s a cobrar -->
                <div class="mb-3">
                    <label class="form-label fw-semibold small">Inter√©s por mora a cobrar:</label>
                    <input type="text" class="form-control text-center" id="pago-interes-mora" 
                           inputmode="numeric" placeholder="0"
                           oninput="formatearInputMonto(this); calcularResumenPago()">
                </div>
                
                <!-- RESUMEN DESTACADO -->
                <div class="pago-resumen mb-3">
                    <div class="pago-resumen-row">
                        <span class="label">Monto cuota:</span>
                        <span class="valor" id="resumen-monto-cuota">$0</span>
                    </div>
                    <div class="pago-resumen-row total">
                        <span class="label">VAS A COBRAR:</span>
                        <span class="valor text-success" id="resumen-total">$0</span>
                    </div>
                    <div class="pago-pendiente-bloque" id="pendiente-bloque" style="display: none;">
                        <div class="pago-resumen-row" id="resumen-restante-row" style="display: none;">
                            <span class="label"><i class="bi bi-exclamation-circle me-1"></i>Restante cuota:</span>
                            <span class="valor text-danger" id="resumen-restante">$0</span>
                        </div>
                        <div class="pago-resumen-row" id="resumen-mora-row" style="display: none;">
                            <span class="label"><i class="bi bi-percent me-1"></i>+ Inter√©s mora:</span>
                            <span class="valor text-warning" id="resumen-mora">$0</span>
                        </div>
                        <div class="pago-resumen-row pendiente-total" id="resumen-pendiente-total-row">
                            <span class="label"><i class="bi bi-exclamation-triangle me-1"></i>TOTAL PENDIENTE:</span>
                            <span class="valor text-danger" id="resumen-pendiente-total">$0</span>
                        </div>
                    </div>
                </div>
                
                <!-- Qu√© hacer con el restante -->
                <div class="mb-3" id="accion-restante-container" style="display: none;">
                    <label class="form-label fw-semibold small text-danger">
                        <i class="bi bi-arrow-right-circle me-1"></i>¬øQu√© hacer con lo pendiente?
                    </label>
                    <select class="form-select" id="pago-accion-restante" onchange="toggleFechaEspecial()">
                        <option value="ignorar">Dejar pendiente en esta cuota</option>
                        <option value="proxima">Sumar a la pr√≥xima cuota</option>
                        <option value="especial">Agendar para otra fecha</option>
                    </select>
                </div>
                
                <div class="mb-3" id="fecha-especial-container" style="display: none;">
                    <label class="form-label small">Fecha para pagar lo pendiente:</label>
                    <input type="date" class="form-control" id="pago-fecha-especial">
                </div>
                
                <!-- M√©todo de pago -->
                <div class="mb-3">
                    <label class="form-label fw-semibold small">M√©todo de pago:</label>
                    <select class="form-select" id="pago-metodo" onchange="toggleMetodoPago()">
                        <option value="EF">Efectivo</option>
                        <option value="TR">Transferencia</option>
                        <option value="MX">Mixto</option>
                    </select>
                </div>
                
                <div id="metodo-mixto-container" style="display: none;">
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="form-label small">Efectivo:</label>
                            <input type="text" class="form-control" id="pago-monto-efectivo" 
                                   inputmode="numeric" placeholder="0"
                                   oninput="formatearInputMonto(this); validarMontosMixtos()">
                        </div>
                        <div class="col-6">
                            <label class="form-label small">Transferencia:</label>
                            <input type="text" class="form-control" id="pago-monto-transferencia" 
                                   inputmode="numeric" placeholder="0"
                                   oninput="formatearInputMonto(this); validarMontosMixtos()">
                        </div>
                    </div>
                </div>
                
                <div id="referencia-container" style="display: none;">
                    <div class="mb-3">
                        <label class="form-label small">Referencia/N¬∫ operaci√≥n:</label>
                        <input type="text" class="form-control" id="pago-referencia" placeholder="N√∫mero de operaci√≥n">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="confirmarPagoParcial()">
                    <i class="bi bi-check-lg me-1"></i>Registrar Cobro
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// ============ FUNCIONES DE FORMATO ============
function formatearNumero(num) {
    return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

function formatearMoneda(num) {
    return '$ ' + formatearNumero(num);
}

function formatearInputMonto(input) {
    let val = input.value.replace(/[^\d]/g, '');
    if (val) {
        val = parseInt(val).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }
    input.value = val;
}

// ============ M√âTODO DE PAGO ============
function toggleMetodoPago() {
    const metodo = document.getElementById('pago-metodo').value;
    const mixtoContainer = document.getElementById('metodo-mixto-container');
    const referenciaContainer = document.getElementById('referencia-container');
    
    if (metodo === 'MX') {
        mixtoContainer.style.display = 'block';
        referenciaContainer.style.display = 'block';
        // Pre-llenar efectivo con el monto de la cuota (la mora se registra aparte)
        const montoCuota = parseFloat(document.getElementById('pago-monto').value.replace(/\./g, '').replace(',', '.')) || 0;
        document.getElementById('pago-monto-efectivo').value = formatearNumero(montoCuota);
        document.getElementById('pago-monto-transferencia').value = '0';
        validarMontosMixtos();
    } else if (metodo === 'TR') {
        mixtoContainer.style.display = 'none';
        referenciaContainer.style.display = 'block';
    } else {
        mixtoContainer.style.display = 'none';
        referenciaContainer.style.display = 'none';
    }
}

function validarMontosMixtos() {
    const montoCuota = parseFloat(document.getElementById('pago-monto').value.replace(/\./g, '').replace(',', '.')) || 0;
    const montoEfectivo = parseFloat(document.getElementById('pago-monto-efectivo').value.replace(/\./g, '').replace(',', '.')) || 0;
    const montoTransferencia = parseFloat(document.getElementById('pago-monto-transferencia').value.replace(/\./g, '').replace(',', '.')) || 0;
    
    const suma = montoEfectivo + montoTransferencia;
    if (Math.abs(suma - montoCuota) > 1 && suma > 0) {
        document.getElementById('pago-monto-efectivo').classList.add('is-invalid');
        document.getElementById('pago-monto-transferencia').classList.add('is-invalid');
    } else {
        document.getElementById('pago-monto-efectivo').classList.remove('is-invalid');
        document.getElementById('pago-monto-transferencia').classList.remove('is-invalid');
    }
}

// ============ MODAL DE PAGO PARCIAL ============
let diasVencidaActual = 0;
let montoMaxActual = 0;
let fechaCuotaActual = '';

function showPagoParcialModal(cuotaId, monto, cliente, mora, diasVencida, fechaCuota) {
    diasVencidaActual = diasVencida;
    montoMaxActual = monto;
    fechaCuotaActual = fechaCuota;
    
    document.getElementById('pago-cuota-id').value = cuotaId;
    document.getElementById('pago-monto-max').value = monto;
    document.getElementById('pago-cliente-nombre').textContent = cliente;
    document.getElementById('pago-monto-max-label').textContent = formatearMoneda(monto);
    document.getElementById('pago-monto').value = formatearNumero(monto);
    document.getElementById('pago-accion-restante').value = 'ignorar';
    document.getElementById('pago-metodo').value = 'EF';
    document.getElementById('pago-monto-efectivo').value = '';
    document.getElementById('pago-monto-transferencia').value = '';
    document.getElementById('pago-referencia').value = '';
    document.getElementById('pago-interes-mora').value = '0';
    
    if (fechaCuota) {
        const fecha = new Date(fechaCuota + 'T00:00:00');
        document.getElementById('pago-fecha-cuota').textContent = fecha.toLocaleDateString('es-ES', { day: '2-digit', month: 'short' });
    } else {
        document.getElementById('pago-fecha-cuota').textContent = 'Hoy';
    }
    
    document.getElementById('pago-dias-mora-input').value = diasVencida;
    calcularInteresDesdeporcentaje();
    
    const infoMoraContainer = document.getElementById('info-mora-container');
    if (diasVencida > 0) {
        infoMoraContainer.style.display = 'block';
        document.getElementById('pago-dias-vencida').textContent = diasVencida;
    } else {
        infoMoraContainer.style.display = 'none';
    }
    
    toggleFechaEspecial();
    toggleMetodoPago();
    calcularResumenPago();
    
    const modal = new bootstrap.Modal(document.getElementById('modal-pago-parcial'));
    modal.show();
}

function calcularInteresDesdeporcentaje() {
    const porcentaje = parseFloat(document.getElementById('pago-porcentaje-input').value) || 0;
    const dias = parseInt(document.getElementById('pago-dias-mora-input').value) || 0;
    const montoStr = document.getElementById('pago-monto').value;
    const montoCobrar = parseFloat(montoStr.replace(/\./g, '').replace(',', '.')) || 0;
    
    const restante = montoMaxActual - montoCobrar;
    const baseCalculo = restante > 0 ? restante : montoMaxActual;
    const interes = Math.round((baseCalculo * porcentaje / 100) * dias);
    
    const label = restante > 0 ? 
        `Sobre restante (${formatearMoneda(restante)})` : 
        `Sobre cuota (${formatearMoneda(montoMaxActual)})`;
    document.getElementById('interes-calculado-preview').innerHTML = 
        `${formatearMoneda(interes)}<br><small class="text-muted">${label}</small>`;
}

function aplicarInteresCalculado() {
    const porcentaje = parseFloat(document.getElementById('pago-porcentaje-input').value) || 0;
    const dias = parseInt(document.getElementById('pago-dias-mora-input').value) || 0;
    const montoStr = document.getElementById('pago-monto').value;
    const montoCobrar = parseFloat(montoStr.replace(/\./g, '').replace(',', '.')) || 0;
    
    const restante = montoMaxActual - montoCobrar;
    const baseCalculo = restante > 0 ? restante : montoMaxActual;
    const interes = Math.round((baseCalculo * porcentaje / 100) * dias);
    document.getElementById('pago-interes-mora').value = formatearNumero(interes);
    calcularResumenPago();
}

function calcularResumenPago() {
    const montoStr = document.getElementById('pago-monto').value;
    const interesMoraStr = document.getElementById('pago-interes-mora').value;
    
    const monto = parseFloat(montoStr.replace(/\./g, '').replace(',', '.')) || 0;
    const interesMora = parseFloat(interesMoraStr.replace(/\./g, '').replace(',', '.')) || 0;
    const montoMax = montoMaxActual;
    
    // Mostrar monto de cuota
    document.getElementById('resumen-monto-cuota').textContent = formatearMoneda(montoMax);
    
    // Total a cobrar (solo lo que paga el cliente, sin mora)
    document.getElementById('resumen-total').textContent = formatearMoneda(monto);
    
    // Monto restante de la cuota
    const restante = montoMax - monto;
    const pendienteBloque = document.getElementById('pendiente-bloque');
    const restanteRow = document.getElementById('resumen-restante-row');
    const moraRow = document.getElementById('resumen-mora-row');
    const pendienteTotalRow = document.getElementById('resumen-pendiente-total-row');
    const accionContainer = document.getElementById('accion-restante-container');
    
    const totalPendiente = Math.max(0, restante) + interesMora;
    
    if (totalPendiente > 0) {
        pendienteBloque.style.display = 'block';
        accionContainer.style.display = 'block';
        
        // Restante de cuota
        restanteRow.style.display = restante > 0 ? 'flex' : 'none';
        if (restante > 0) {
            document.getElementById('resumen-restante').textContent = formatearMoneda(restante);
        }
        
        // Mora
        moraRow.style.display = interesMora > 0 ? 'flex' : 'none';
        if (interesMora > 0) {
            document.getElementById('resumen-mora').textContent = formatearMoneda(interesMora);
        }
        
        // Total pendiente
        document.getElementById('resumen-pendiente-total').textContent = formatearMoneda(totalPendiente);
    } else {
        pendienteBloque.style.display = 'none';
        accionContainer.style.display = 'none';
    }
}

function toggleFechaEspecial() {
    const accion = document.getElementById('pago-accion-restante').value;
    document.getElementById('fecha-especial-container').style.display = 
        accion === 'especial' ? 'block' : 'none';
}

async function confirmarPagoParcial() {
    const cuotaId = document.getElementById('pago-cuota-id').value;
    const montoStr = document.getElementById('pago-monto').value;
    const monto = parseFloat(montoStr.replace(/\./g, '').replace(',', '.')) || 0;
    const accionRestante = document.getElementById('pago-accion-restante').value;
    const fechaEspecial = document.getElementById('pago-fecha-especial').value;
    
    const metodoPago = document.getElementById('pago-metodo').value;
    const montoEfectivoStr = document.getElementById('pago-monto-efectivo').value;
    const montoTransferenciaStr = document.getElementById('pago-monto-transferencia').value;
    const montoEfectivo = parseFloat(montoEfectivoStr.replace(/\./g, '').replace(',', '.')) || 0;
    const montoTransferencia = parseFloat(montoTransferenciaStr.replace(/\./g, '').replace(',', '.')) || 0;
    const referencia = document.getElementById('pago-referencia').value;
    
    const interesMoraStr = document.getElementById('pago-interes-mora').value;
    const interesMora = parseFloat(interesMoraStr.replace(/\./g, '').replace(',', '.')) || 0;
    
    if (monto <= 0) {
        showToast('El monto debe ser mayor a 0', 'danger');
        return;
    }
    
    // Validar montos mixtos: la suma debe igualar el monto de cuota (la mora se registra aparte)
    if (metodoPago === 'MX' && Math.abs((montoEfectivo + montoTransferencia) - monto) > 1) {
        showToast('La suma de efectivo y transferencia debe ser igual al monto de la cuota', 'danger');
        return;
    }
    
    const data = {
        monto: monto,
        accion_restante: accionRestante,
        fecha_especial: fechaEspecial || null,
        metodo_pago: metodoPago,
        monto_efectivo: montoEfectivo,
        monto_transferencia: montoTransferencia,
        referencia_transferencia: referencia,
        interes_mora: interesMora
    };
    
    try {
        const response = await fetch(`/api/cobrar/${cuotaId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Cerrar modal de pago parcial
            const modalParcial = bootstrap.Modal.getInstance(document.getElementById('modal-pago-parcial'));
            if (modalParcial) modalParcial.hide();
            
            // Mostrar animaci√≥n de √©xito  
            showSuccessModal();
            
            // Actualizar la cuota en la UI
            const cuotaItem = document.querySelector(`.btn-cobrar[data-cuota-id="${cuotaId}"]`)?.closest('.cuota-item');
            if (cuotaItem) {
                if (monto >= montoMaxActual) {
                    // Pago completo: marcar como pagada
                    cuotaItem.classList.remove('pendiente', 'vencida');
                    cuotaItem.classList.add('pagada');
                    const estadoEl = cuotaItem.querySelector('.cuota-estado');
                    if (estadoEl) {
                        estadoEl.className = 'cuota-estado pagada';
                        estadoEl.innerHTML = '<i class="bi bi-check-circle-fill me-1"></i>Pagado';
                    }
                    const accionEl = cuotaItem.querySelector('.cuota-accion');
                    if (accionEl) {
                        const hoy = new Date().toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                        accionEl.innerHTML = `
                            <div class="d-flex align-items-center gap-1">
                                <div class="check-pagado"><i class="bi bi-check-lg"></i></div>
                                <button class="btn-wp-talon"
                                    data-telefono="{{ prestamo.cliente.telefono }}"
                                    data-cliente="{{ prestamo.cliente.nombre_completo }}"
                                    data-fecha="${hoy}"
                                    data-cuota="${cuotaItem.querySelector('.numero')?.textContent || '1'}"
                                    data-total-cuotas="{{ prestamo.cuotas_pactadas }}"
                                    data-monto="${montoMaxActual}"
                                    data-saldo="${Math.max(0, {{ prestamo.monto_pendiente|numero_raw }} - monto)}"
                                    title="Enviar tal√≥n por WhatsApp"
                                    style="width:28px;height:28px;border-radius:50%;border:1px solid #25D366;background:#25D366;color:white;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:0.85rem;">
                                    <i class="bi bi-whatsapp"></i>
                                </button>
                            </div>`;
                    }
                    const montoDiv = cuotaItem.querySelector('.cuota-monto');
                    if (montoDiv) {
                        const restanteEl = montoDiv.querySelector('.monto-restante');
                        if (restanteEl) restanteEl.remove();
                        const hoy = new Date().toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit' });
                        if (!montoDiv.querySelector('.fecha-pago')) {
                            montoDiv.insertAdjacentHTML('beforeend', `<div class="fecha-pago"><i class="bi bi-check2"></i> ${hoy}</div>`);
                        }
                    }
                } else {
                    // Pago parcial: actualizar monto restante
                    const nuevoRestante = montoMaxActual - monto;
                    const estadoEl = cuotaItem.querySelector('.cuota-estado');
                    if (estadoEl) {
                        estadoEl.className = 'cuota-estado parcial';
                        estadoEl.innerHTML = '<i class="bi bi-pie-chart-fill me-1"></i>Parcial';
                    }
                    const montoDiv = cuotaItem.querySelector('.cuota-monto');
                    if (montoDiv) {
                        let restanteEl = montoDiv.querySelector('.monto-restante');
                        if (!restanteEl) {
                            montoDiv.insertAdjacentHTML('beforeend', `<div class="monto-restante">Resta: ${formatearMoneda(nuevoRestante)}</div>`);
                        } else {
                            restanteEl.textContent = `Resta: ${formatearMoneda(nuevoRestante)}`;
                        }
                    }
                    // Actualizar data-monto en botones
                    const btnCobrar = cuotaItem.querySelector('.btn-cobrar');
                    if (btnCobrar) btnCobrar.dataset.monto = nuevoRestante;
                    const btnEditar = cuotaItem.querySelector('.btn-editar-cobro');
                    if (btnEditar) btnEditar.dataset.monto = nuevoRestante;
                }
            }
        } else {
            showToast(result.message || 'Error al registrar el cobro', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Error de conexi√≥n', 'danger');
    }
}

// Delegaci√≥n de eventos para bot√≥n editar cobro
document.addEventListener('click', function(e) {
    const btn = e.target.closest('.btn-editar-cobro');
    if (btn) {
        e.preventDefault();
        e.stopPropagation();
        showPagoParcialModal(
            btn.dataset.cuotaId,
            parseFloat(btn.dataset.monto),
            btn.dataset.cliente,
            parseFloat(btn.dataset.mora || 0),
            parseInt(btn.dataset.diasVencida || 0),
            btn.dataset.fecha || ''
        );
    }
});

// ============ ENVIAR TAL√ìN POR WHATSAPP ============
document.addEventListener('click', function(e) {
    const btn = e.target.closest('.btn-wp-talon');
    if (!btn) return;
    e.preventDefault();
    e.stopPropagation();

    const telefono = btn.dataset.telefono;
    const cliente = btn.dataset.cliente;
    const fecha = btn.dataset.fecha;
    const cuota = String(parseInt(btn.dataset.cuota)).padStart(2, '0');
    const totalCuotas = String(parseInt(btn.dataset.totalCuotas)).padStart(2, '0');
    const monto = parseFloat(btn.dataset.monto) || 0;
    const saldo = parseFloat(btn.dataset.saldo) || 0;

    const montoFmt = Math.round(monto).toLocaleString('es-AR');
    const saldoFmt = Math.round(saldo).toLocaleString('es-AR');

    const mensaje = `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
      *PRONTO CRED*
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

*CLIENTE:* ${cliente.toUpperCase()}
*FECHA:* ${fecha}

*DETALLE DEL PAGO:*
--------------------------------------
\`CUOTA:           ${cuota} / ${totalCuotas}\`
\`VALOR ABONADO:   $ ${montoFmt}\`
\`SALDO RESTANTE:  $ ${saldoFmt}\`
--------------------------------------

*‚ö†Ô∏è AVISO IMPORTANTE:*
La cuota no abonada en fecha sufrir√° un recargo del 50% del valor de la cuota y del 100% si la cuota se acumula.

*CONTACTO:*
üìû 11 3271-6516
üìû 11 5056-0854

_¬°Gracias por su pago!_
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`;

    // Formatear tel√©fono para Argentina
    let tel = telefono.replace(/[^0-9]/g, '');
    if (tel.startsWith('0')) tel = tel.substring(1);
    if (!tel.startsWith('54')) tel = '54' + tel;

    window.open(`https://wa.me/${tel}?text=${encodeURIComponent(mensaje)}`, '_blank');
});

// ============ ANULAR PAGO ============
document.addEventListener('click', function(e) {
    const btn = e.target.closest('.btn-anular-pago');
    if (!btn) return;
    e.preventDefault();
    e.stopPropagation();
    
    const cuotaId = btn.dataset.cuotaId;
    const cliente = btn.dataset.cliente;
    const monto = parseFloat(btn.dataset.monto) || 0;
    
    if (!confirm(`¬øEst√°s seguro de anular el pago de ${formatearMoneda(monto)} de ${cliente}?\n\nLa cuota volver√° a estado pendiente.`)) {
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" style="width:12px;height:12px;"></span>';
    
    fetch(`/api/anular-pago/${cuotaId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            // Recargar la p√°gina para reflejar los cambios correctamente
            location.reload();
        } else {
            alert(result.message || 'Error al anular el pago');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-x-lg"></i>';
        }
    })
    .catch(error => {
        alert('Error de conexi√≥n');
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-x-lg"></i>';
    });
});
</script>
{% endblock %}
