{% extends 'base.html' %}
{% load static %}
{% load currency_filters %}

{% block title %}Cobros del Día - Préstamos{% endblock %}

{% block content %}
<div class="container-fluid px-2 px-lg-4">
    
    <!-- Barra de acciones -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h5 mb-0 d-none d-lg-block">
            <i class="bi bi-cash-stack me-2"></i>Cobros del Día
        </h1>
        <div class="ms-auto d-flex gap-2">
            <!-- Filtro por zona -->
            <select class="form-select form-select-sm" id="filtro-zona" style="width: auto;">
                <option value="">Todas las zonas</option>
                {% for ruta in rutas %}
                <option value="{{ ruta.nombre }}">{{ ruta.nombre }}</option>
                {% endfor %}
            </select>
            <a href="{% url 'core:exportar_planilla_excel' %}?fecha={{ fecha_hoy|date:'Y-m-d' }}" class="btn btn-sm btn-outline-success">
                <i class="bi bi-file-earmark-excel me-1"></i> Excel
            </a>
        </div>
    </div>
    
    <!-- Resumen rápido -->
    <div class="row g-2 mb-4">
        <div class="col-4">
            <div class="stat-card">
                <div class="stat-icon bg-success bg-opacity-10 text-success">
                    <i class="bi bi-cash-stack"></i>
                </div>
                <div class="stat-value text-success" id="total-cobrado-hoy">
                    {{ total_cobrado_hoy|dinero }}
                </div>
                <div class="stat-label">Cobrado</div>
            </div>
        </div>
        <div class="col-4">
            <div class="stat-card">
                <div class="stat-icon bg-warning bg-opacity-10 text-warning">
                    <i class="bi bi-clock-history"></i>
                </div>
                <div class="stat-value">{{ total_por_cobrar|dinero }}</div>
                <div class="stat-label">Por Cobrar</div>
            </div>
        </div>
        <div class="col-4">
            <div class="stat-card">
                <div class="stat-icon bg-danger bg-opacity-10 text-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
                <div class="stat-value">{{ total_vencidas|dinero }}</div>
                <div class="stat-label">Vencidas</div>
            </div>
        </div>
    </div>
    
    <!-- Accordion de secciones -->
    <div class="accordion" id="accordionCobros">
        
        <!-- Cuotas vencidas (prioritarias) -->
        {% if cuotas_vencidas %}
        <div class="accordion-item border-danger">
            <h2 class="accordion-header">
                <button class="accordion-button bg-danger bg-opacity-10 text-danger" type="button" data-bs-toggle="collapse" data-bs-target="#collapseVencidas" aria-expanded="true">
                    <i class="bi bi-exclamation-circle-fill me-2"></i>
                    <strong>Cuotas Vencidas</strong>
                    <span class="badge bg-danger ms-2">{{ cuotas_vencidas|length }}</span>
                    <span class="ms-2 small">{{ total_vencidas|dinero }}</span>
                </button>
            </h2>
            <div id="collapseVencidas" class="accordion-collapse collapse show" data-bs-parent="#accordionCobros">
                <div class="accordion-body p-2">
                    {% for cuota in cuotas_vencidas %}
                    <div class="cobro-card-simple estado-vencido filtrable" data-zona="{{ cuota.prestamo.cliente.ruta.nombre|default:'Sin Zona' }}">
                        <div class="card-row-main">
                            <div class="card-avatar">{{ cuota.prestamo.cliente.nombre|slice:":1" }}{{ cuota.prestamo.cliente.apellido|slice:":1" }}</div>
                            <div class="card-info" onclick="this.parentElement.parentElement.classList.toggle('open')">
                                <span class="card-nombre">{{ cuota.prestamo.cliente.nombre_completo|truncatewords:3 }}</span>
                                <span class="card-cuota">{{ cuota.numero_cuota }}/{{ cuota.prestamo.cuotas_pactadas }} <span class="text-danger">({{ cuota.dias_vencida }}d)</span></span>
                            </div>
                            <div class="card-monto text-danger">{{ cuota.monto_restante|dinero }}</div>
                            <button type="button" class="btn-cobrar-rapido btn-editar-cobro"
                                    data-cuota-id="{{ cuota.pk }}"
                                    data-monto="{{ cuota.monto_restante|numero_raw }}"
                                    data-mora="{{ cuota.interes_mora_pendiente|numero_raw }}"
                                    data-cliente="{{ cuota.prestamo.cliente.nombre_completo }}"
                                    data-dias-vencida="{{ cuota.dias_vencida }}">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button type="button" class="btn-cobrar-rapido btn-cobrar btn-success-custom" data-cuota-id="{{ cuota.pk }}">
                                <i class="bi bi-check-lg"></i>
                            </button>
                        </div>
                        <div class="card-row-details">
                            <div><i class="bi bi-telephone"></i> {{ cuota.prestamo.cliente.telefono|default:'-' }}</div>
                            <div><i class="bi bi-geo-alt"></i> {{ cuota.prestamo.cliente.direccion|truncatewords:5|default:'-' }}</div>
                            <div><i class="bi bi-calendar"></i> Fin: {{ cuota.prestamo.fecha_finalizacion|date:"d/m/Y" }}</div>
                            {% if cuota.interes_mora_pendiente > 0 %}<div class="text-warning"><i class="bi bi-percent"></i> Mora: {{ cuota.interes_mora_pendiente|dinero }}</div>{% endif %}
                            {% if cuota.prestamo.cliente.ruta %}<div><i class="bi bi-pin-map"></i> {{ cuota.prestamo.cliente.ruta.nombre }}</div>{% endif %}
                            <a href="{% url 'core:cliente_detail' cuota.prestamo.cliente.pk %}" class="btn btn-sm btn-outline-primary mt-2"><i class="bi bi-person"></i> Ver cliente</a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Cobros del día -->
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button {% if cuotas_vencidas %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapseHoy" aria-expanded="{% if not cuotas_vencidas %}true{% else %}false{% endif %}">
                    <i class="bi bi-calendar-check me-2"></i>
                    <strong>Cobros de Hoy</strong>
                    <span class="badge bg-primary ms-2">{{ cuotas_hoy|length }}</span>
                    <span class="ms-2 small">{{ total_por_cobrar|dinero }}</span>
                </button>
            </h2>
            <div id="collapseHoy" class="accordion-collapse collapse {% if not cuotas_vencidas %}show{% endif %}" data-bs-parent="#accordionCobros">
                <div class="accordion-body p-2">
                    {% if cuotas_hoy %}
                        {% for cuota in cuotas_hoy %}
                        <div class="cobro-card-simple estado-pendiente filtrable" data-zona="{{ cuota.prestamo.cliente.ruta.nombre|default:'Sin Zona' }}">
                            <div class="card-row-main">
                                <div class="card-avatar">{{ cuota.prestamo.cliente.nombre|slice:":1" }}{{ cuota.prestamo.cliente.apellido|slice:":1" }}</div>
                                <div class="card-info" onclick="this.parentElement.parentElement.classList.toggle('open')">
                                    <span class="card-nombre">{{ cuota.prestamo.cliente.nombre_completo|truncatewords:3 }}</span>
                                    <span class="card-cuota">{{ cuota.numero_cuota }}/{{ cuota.prestamo.cuotas_pactadas }}{% if cuota.estado == 'PC' %} <span class="text-warning">●</span>{% endif %}</span>
                                </div>
                                <div class="card-monto">{{ cuota.monto_restante|dinero }}</div>
                                <button type="button" class="btn-cobrar-rapido btn-editar-cobro"
                                        data-cuota-id="{{ cuota.pk }}"
                                        data-monto="{{ cuota.monto_restante|numero_raw }}"
                                        data-mora="0"
                                        data-cliente="{{ cuota.prestamo.cliente.nombre_completo }}"
                                        data-dias-vencida="0">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button type="button" class="btn-cobrar-rapido btn-cobrar btn-success-custom" data-cuota-id="{{ cuota.pk }}">
                                    <i class="bi bi-check-lg"></i>
                                </button>
                            </div>
                            <div class="card-row-details">
                                <div><i class="bi bi-telephone"></i> {{ cuota.prestamo.cliente.telefono|default:'-' }}</div>
                                <div><i class="bi bi-geo-alt"></i> {{ cuota.prestamo.cliente.direccion|truncatewords:5|default:'-' }}</div>
                                <div><i class="bi bi-calendar"></i> Fin: {{ cuota.prestamo.fecha_finalizacion|date:"d/m/Y" }}</div>
                                {% if cuota.prestamo.cliente.ruta %}<div><i class="bi bi-pin-map"></i> {{ cuota.prestamo.cliente.ruta.nombre }}</div>{% endif %}
                                <a href="{% url 'core:cliente_detail' cuota.prestamo.cliente.pk %}" class="btn btn-sm btn-outline-primary mt-2"><i class="bi bi-person"></i> Ver cliente</a>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state py-4 text-center">
                            <i class="bi bi-emoji-smile fs-1 text-muted"></i>
                            <h5 class="mt-2">¡Sin cobros pendientes!</h5>
                            <p class="text-muted">No hay cuotas programadas para hoy.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Cuotas Próximas (7 días) -->
        {% if cuotas_proximas %}
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseProximas" aria-expanded="false">
                    <i class="bi bi-calendar-week me-2 text-info"></i>
                    <strong>Próximos 7 días</strong>
                    <span class="badge bg-info ms-2">{{ cuotas_proximas|length }}</span>
                    <span class="ms-2 small">{{ total_proximas|dinero }}</span>
                </button>
            </h2>
            <div id="collapseProximas" class="accordion-collapse collapse" data-bs-parent="#accordionCobros">
                <div class="accordion-body p-2">
                    {% for cuota in cuotas_proximas %}
                    <div class="cobro-card-simple estado-proximo filtrable" data-zona="{{ cuota.prestamo.cliente.ruta.nombre|default:'Sin Zona' }}">
                        <div class="card-row-main">
                            <div class="card-avatar bg-info">{{ cuota.prestamo.cliente.nombre|slice:":1" }}{{ cuota.prestamo.cliente.apellido|slice:":1" }}</div>
                            <div class="card-info" onclick="this.parentElement.parentElement.classList.toggle('open')">
                                <span class="card-nombre">{{ cuota.prestamo.cliente.nombre_completo|truncatewords:3 }}</span>
                                <span class="card-cuota">{{ cuota.numero_cuota }}/{{ cuota.prestamo.cuotas_pactadas }} <span class="text-info">({{ cuota.fecha_vencimiento|date:"d/m" }})</span></span>
                            </div>
                            <div class="card-monto text-info">{{ cuota.monto_restante|dinero }}</div>
                        </div>
                        <div class="card-row-details">
                            <div><i class="bi bi-telephone"></i> {{ cuota.prestamo.cliente.telefono|default:'-' }}</div>
                            <div><i class="bi bi-geo-alt"></i> {{ cuota.prestamo.cliente.direccion|truncatewords:5|default:'-' }}</div>
                            <div><i class="bi bi-calendar"></i> Fin: {{ cuota.prestamo.fecha_finalizacion|date:"d/m/Y" }}</div>
                            {% if cuota.prestamo.cliente.ruta %}<div><i class="bi bi-pin-map"></i> {{ cuota.prestamo.cliente.ruta.nombre }}</div>{% endif %}
                            <a href="{% url 'core:cliente_detail' cuota.prestamo.cliente.pk %}" class="btn btn-sm btn-outline-info mt-2"><i class="bi bi-person"></i> Ver cliente</a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
        
    </div>
    
</div>

<!-- FAB para nuevo préstamo -->
<a href="{% url 'core:prestamo_create' %}" class="fab no-print" title="Nuevo Préstamo">
    <i class="bi bi-plus-lg"></i>
</a>

<!-- Modal para cobro personalizado -->
<div class="modal fade" id="modal-pago-parcial" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-cash-stack me-2"></i>Cobro Personalizado
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="pago-cuota-id">
                <input type="hidden" id="pago-monto-max">
                
                <div class="alert alert-light border mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Cliente:</span>
                        <strong id="pago-cliente-nombre"></strong>
                    </div>
                    <hr class="my-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Monto de cuota:</span>
                        <strong id="pago-monto-max-label" class="text-primary fs-5">$0</strong>
                    </div>
                    <div id="info-mora-container" style="display: none;">
                        <hr class="my-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Días de atraso:</span>
                            <strong id="pago-dias-vencida" class="text-danger">0</strong>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Interés por mora sugerido:</span>
                            <strong id="pago-mora-sugerida" class="text-warning">$0</strong>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-cash me-1"></i>Monto a cobrar:
                            </label>
                            <input type="text" class="form-control form-control-lg" id="pago-monto" 
                                   inputmode="numeric" placeholder="0"
                                   oninput="formatearInputMonto(this); actualizarMontoFormateado()">
                            <div class="form-text">
                                <span id="monto-formateado-label"></span>
                            </div>
                        </div>
                        
                        <div class="mb-3" id="mora-container">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-percent me-1"></i>Interés por mora a cobrar:
                            </label>
                            <input type="text" class="form-control" id="pago-interes-mora" 
                                   inputmode="numeric" placeholder="0"
                                   oninput="formatearInputMonto(this)">
                            <div class="form-text">Dejar en 0 si no cobrará mora</div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-credit-card me-1"></i>Método de pago:
                            </label>
                            <select class="form-select" id="pago-metodo" onchange="toggleMetodoPago()">
                                <option value="EF">Efectivo</option>
                                <option value="TR">Transferencia</option>
                                <option value="MX">Mixto (Efectivo + Transferencia)</option>
                            </select>
                        </div>
                        
                        <div id="metodo-mixto-container" style="display: none;">
                            <div class="mb-2">
                                <label class="form-label small">Monto en efectivo:</label>
                                <input type="text" class="form-control" id="pago-monto-efectivo" 
                                       inputmode="numeric" placeholder="0"
                                       oninput="formatearInputMonto(this); validarMontosMixtos()">
                            </div>
                            <div class="mb-2">
                                <label class="form-label small">Monto en transferencia:</label>
                                <input type="text" class="form-control" id="pago-monto-transferencia" 
                                       inputmode="numeric" placeholder="0"
                                       oninput="formatearInputMonto(this); validarMontosMixtos()">
                            </div>
                        </div>
                        
                        <div id="referencia-container" style="display: none;">
                            <div class="mb-2">
                                <label class="form-label small">Referencia/Nº operación:</label>
                                <input type="text" class="form-control" id="pago-referencia" 
                                       placeholder="Número de operación">
                            </div>
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <div class="mb-3">
                    <label class="form-label fw-semibold">
                        <i class="bi bi-arrow-repeat me-1"></i>¿Qué hacer con el restante?
                    </label>
                    <select class="form-select" id="pago-accion-restante" onchange="toggleFechaEspecial()">
                        <option value="ignorar">Dejar pendiente en esta cuota</option>
                        <option value="proxima">Sumar a la próxima cuota</option>
                        <option value="especial">Agendar cuota especial en otra fecha</option>
                    </select>
                    <small class="text-muted">Si cobra el monto completo, esta opción se ignora</small>
                </div>
                
                <div class="mb-3" id="fecha-especial-container" style="display: none;">
                    <label class="form-label fw-semibold">
                        <i class="bi bi-calendar-event me-1"></i>Fecha de cuota especial:
                    </label>
                    <input type="date" class="form-control" id="pago-fecha-especial">
                    <div class="form-text">Se creará una nueva cuota para esta fecha</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-success btn-lg" onclick="confirmarPagoParcial()">
                    <i class="bi bi-check-lg me-1"></i>Registrar Cobro
                </button>
            </div>
        </div>
    </div>
</div>

{% csrf_token %}

<!-- Modal para cambiar categoría -->
<div class="modal fade" id="modal-categoria" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-tag me-2"></i>Cambiar Categoría
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="categoria-cliente-id">
                <p class="text-muted mb-3">Selecciona la nueva categoría:</p>
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-success btn-categoria-opcion" data-categoria="EX">
                        <i class="bi bi-star-fill me-2"></i>Excelente
                    </button>
                    <button type="button" class="btn btn-outline-warning btn-categoria-opcion" data-categoria="RE">
                        <i class="bi bi-dash-circle me-2"></i>Regular
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-categoria-opcion" data-categoria="MO">
                        <i class="bi bi-exclamation-triangle me-2"></i>Moroso
                    </button>
                    <button type="button" class="btn btn-outline-info btn-categoria-opcion" data-categoria="NU">
                        <i class="bi bi-person-plus me-2"></i>Nuevo
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ============ FILTRO POR ZONA ============
document.getElementById('filtro-zona').addEventListener('change', function() {
    const zonaSeleccionada = this.value.toLowerCase();
    document.querySelectorAll('.filtrable').forEach(card => {
        const zonaCard = (card.dataset.zona || '').toLowerCase();
        if (!zonaSeleccionada || zonaCard.includes(zonaSeleccionada)) {
            card.style.display = '';
        } else {
            card.style.display = 'none';
        }
    });
});

// ============ MÉTODO DE PAGO ============
function toggleMetodoPago() {
    const metodo = document.getElementById('pago-metodo').value;
    const mixtoContainer = document.getElementById('metodo-mixto-container');
    const referenciaContainer = document.getElementById('referencia-container');
    
    if (metodo === 'MX') {
        mixtoContainer.style.display = 'block';
        referenciaContainer.style.display = 'block';
    } else if (metodo === 'TR') {
        mixtoContainer.style.display = 'none';
        referenciaContainer.style.display = 'block';
    } else {
        mixtoContainer.style.display = 'none';
        referenciaContainer.style.display = 'none';
    }
}

function validarMontosMixtos() {
    const montoTotal = parseFloat(document.getElementById('pago-monto').value.replace(/\./g, '').replace(',', '.')) || 0;
    const montoEfectivo = parseFloat(document.getElementById('pago-monto-efectivo').value.replace(/\./g, '').replace(',', '.')) || 0;
    const montoTransferencia = parseFloat(document.getElementById('pago-monto-transferencia').value.replace(/\./g, '').replace(',', '.')) || 0;
    
    const suma = montoEfectivo + montoTransferencia;
    if (suma !== montoTotal && suma > 0) {
        document.getElementById('pago-monto-efectivo').classList.add('is-invalid');
        document.getElementById('pago-monto-transferencia').classList.add('is-invalid');
    } else {
        document.getElementById('pago-monto-efectivo').classList.remove('is-invalid');
        document.getElementById('pago-monto-transferencia').classList.remove('is-invalid');
    }
}

// ============ MODAL DE PAGO PARCIAL ============
function showPagoParcialModal(cuotaId, monto, cliente, mora = 0, diasVencida = 0) {
    document.getElementById('pago-cuota-id').value = cuotaId;
    document.getElementById('pago-monto-max').value = monto;
    document.getElementById('pago-cliente-nombre').textContent = cliente;
    document.getElementById('pago-monto-max-label').textContent = formatearMoneda(monto);
    document.getElementById('pago-monto').value = formatearNumero(monto);
    document.getElementById('pago-accion-restante').value = 'ignorar';
    document.getElementById('pago-metodo').value = 'EF';
    document.getElementById('pago-interes-mora').value = mora > 0 ? formatearNumero(mora) : '0';
    document.getElementById('pago-monto-efectivo').value = '';
    document.getElementById('pago-monto-transferencia').value = '';
    document.getElementById('pago-referencia').value = '';
    
    // Mostrar info de mora si hay días vencidos
    const infoMoraContainer = document.getElementById('info-mora-container');
    const moraContainer = document.getElementById('mora-container');
    if (diasVencida > 0) {
        infoMoraContainer.style.display = 'block';
        moraContainer.style.display = 'block';
        document.getElementById('pago-dias-vencida').textContent = diasVencida + ' días';
        document.getElementById('pago-mora-sugerida').textContent = formatearMoneda(mora);
    } else {
        infoMoraContainer.style.display = 'none';
        moraContainer.style.display = 'none';
    }
    
    toggleFechaEspecial();
    toggleMetodoPago();
    actualizarMontoFormateado();
    
    const modal = new bootstrap.Modal(document.getElementById('modal-pago-parcial'));
    modal.show();
}

function toggleFechaEspecial() {
    const accion = document.getElementById('pago-accion-restante').value;
    document.getElementById('fecha-especial-container').style.display = 
        accion === 'especial' ? 'block' : 'none';
}

function actualizarMontoFormateado() {
    const montoInput = document.getElementById('pago-monto').value;
    const monto = parseFloat(montoInput.replace(/\./g, '').replace(',', '.')) || 0;
    document.getElementById('monto-formateado-label').textContent = formatearMoneda(monto);
}

function formatearNumero(num) {
    return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

function formatearMoneda(num) {
    return '$ ' + formatearNumero(num);
}

async function confirmarPagoParcial() {
    const cuotaId = document.getElementById('pago-cuota-id').value;
    const montoStr = document.getElementById('pago-monto').value;
    const monto = parseFloat(montoStr.replace(/\./g, '').replace(',', '.')) || 0;
    const accionRestante = document.getElementById('pago-accion-restante').value;
    const fechaEspecial = document.getElementById('pago-fecha-especial').value;
    
    // Método de pago
    const metodoPago = document.getElementById('pago-metodo').value;
    const montoEfectivoStr = document.getElementById('pago-monto-efectivo').value;
    const montoTransferenciaStr = document.getElementById('pago-monto-transferencia').value;
    const montoEfectivo = parseFloat(montoEfectivoStr.replace(/\./g, '').replace(',', '.')) || 0;
    const montoTransferencia = parseFloat(montoTransferenciaStr.replace(/\./g, '').replace(',', '.')) || 0;
    const referencia = document.getElementById('pago-referencia').value;
    
    // Interés por mora
    const interesMoraStr = document.getElementById('pago-interes-mora').value;
    const interesMora = parseFloat(interesMoraStr.replace(/\./g, '').replace(',', '.')) || 0;
    
    if (monto <= 0) {
        showToast('El monto debe ser mayor a 0', 'danger');
        return;
    }
    
    // Validar montos mixtos
    if (metodoPago === 'MX' && (montoEfectivo + montoTransferencia) !== monto) {
        showToast('La suma de efectivo y transferencia debe ser igual al monto total', 'danger');
        return;
    }
    
    const data = {
        monto: monto,
        accion_restante: accionRestante,
        fecha_especial: fechaEspecial || null,
        metodo_pago: metodoPago,
        monto_efectivo: montoEfectivo,
        monto_transferencia: montoTransferencia,
        referencia_transferencia: referencia,
        interes_mora: interesMora
    };
    
    try {
        const response = await fetch(`/api/cobrar/${cuotaId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast(result.message, 'success');
            
            // Ocultar la card de la cuota cobrada
            const card = document.querySelector(`.cobro-card-simple button[data-cuota-id="${cuotaId}"]`)?.closest('.cobro-card-simple');
            if (card) {
                card.style.transition = 'all 0.3s ease';
                card.style.opacity = '0';
                card.style.transform = 'translateX(100%)';
                setTimeout(() => card.remove(), 300);
            }
            
            // Actualizar estadísticas
            if (result.estadisticas) {
                document.getElementById('total-cobrado-hoy').textContent = 
                    formatearMoneda(result.estadisticas.total_cobrado_hoy);
            }
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modal-pago-parcial'));
            if (modal) modal.hide();
        } else {
            showToast(result.message || 'Error al registrar el cobro', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Error de conexión', 'danger');
    }
}

// Delegación de eventos para botón editar cobro
document.addEventListener('click', function(e) {
    const btn = e.target.closest('.btn-editar-cobro');
    if (btn) {
        e.preventDefault();
        e.stopPropagation();
        const cuotaId = btn.dataset.cuotaId;
        const monto = parseFloat(btn.dataset.monto);
        const cliente = btn.dataset.cliente;
        const mora = parseFloat(btn.dataset.mora || 0);
        const diasVencida = parseInt(btn.dataset.diasVencida || 0);
        showPagoParcialModal(cuotaId, monto, cliente, mora, diasVencida);
    }
});

// Delegación de eventos para botón cobrar completo
document.addEventListener('click', async function(e) {
    const btn = e.target.closest('.btn-cobrar');
    if (!btn) return;
    
    e.preventDefault();
    e.stopPropagation();
    const cuotaId = btn.dataset.cuotaId;
    
    try {
        const response = await fetch(`/api/cobrar/${cuotaId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({})
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast(result.message, 'success');
            
            // Ocultar la card
            const card = btn.closest('.cobro-card-simple');
            if (card) {
                card.style.transition = 'all 0.3s ease';
                card.style.opacity = '0';
                card.style.transform = 'translateX(100%)';
                setTimeout(() => card.remove(), 300);
            }
            
            // Actualizar estadísticas
            if (result.estadisticas) {
                document.getElementById('total-cobrado-hoy').textContent = 
                    formatearMoneda(result.estadisticas.total_cobrado_hoy);
            }
        } else {
            showToast(result.message || 'Error', 'danger');
        }
    } catch (error) {
        showToast('Error de conexión', 'danger');
    }
});

// Context menu y long press para abrir modal desde botón cobrar
document.addEventListener('contextmenu', function(e) {
    const btn = e.target.closest('.btn-cobrar');
    if (btn) {
        e.preventDefault();
        const card = btn.closest('.cobro-card');
        const editBtn = card.querySelector('.btn-editar-cobro');
        if (editBtn) editBtn.click();
    }
});

// ============ CAMBIO DE CATEGORÍA ============
const modalCategoria = new bootstrap.Modal(document.getElementById('modal-categoria'));

// Delegación de eventos para cambio de categoría
document.addEventListener('click', function(e) {
    const btn = e.target.closest('.btn-categoria');
    if (btn) {
        e.preventDefault();
        e.stopPropagation();
        const clienteId = btn.dataset.clienteId;
        document.getElementById('categoria-cliente-id').value = clienteId;
        
        // Resaltar la categoría actual
        const categoriaActual = btn.dataset.categoria;
        document.querySelectorAll('.btn-categoria-opcion').forEach(opcion => {
            opcion.classList.remove('active');
            if (opcion.dataset.categoria === categoriaActual) {
                opcion.classList.add('active');
            }
        });
        
        modalCategoria.show();
    }
});

document.querySelectorAll('.btn-categoria-opcion').forEach(btn => {
    btn.addEventListener('click', async (e) => {
        const clienteId = document.getElementById('categoria-cliente-id').value;
        const nuevaCategoria = btn.dataset.categoria;
        
        try {
            const response = await fetch(`/api/cliente/${clienteId}/categoria/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ categoria: nuevaCategoria })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Actualizar badge en la página
                const badge = document.querySelector(`.btn-categoria[data-cliente-id="${clienteId}"]`);
                if (badge) {
                    badge.dataset.categoria = nuevaCategoria;
                    badge.textContent = data.cliente.categoria_display.slice(0, 3);
                    badge.className = 'badge btn-categoria';
                    if (nuevaCategoria === 'EX') badge.classList.add('bg-success');
                    else if (nuevaCategoria === 'RE') badge.classList.add('bg-warning', 'text-dark');
                    else if (nuevaCategoria === 'MO') badge.classList.add('bg-danger');
                    else badge.classList.add('bg-info');
                }
                
                showToast(data.message, 'success');
                modalCategoria.hide();
            } else {
                showToast(data.message || 'Error al cambiar categoría', 'danger');
            }
        } catch (error) {
            showToast('Error de conexión', 'danger');
        }
    });
});
</script>
{% endblock %}
