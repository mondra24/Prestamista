{% extends 'base.html' %}
{% load static %}
{% load currency_filters %}

{% block title %}Cobros del Día - Préstamos{% endblock %}

{% block content %}
<div class="container-fluid px-2 px-lg-4">
    
    <!-- Barra de acciones -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h5 mb-0 d-none d-lg-block">
            <i class="bi bi-cash-stack me-2"></i>Cobros del Día
        </h1>
        <div class="ms-auto d-flex gap-2">
            <!-- Filtro por zona -->
            <select class="form-select form-select-sm" id="filtro-zona" style="width: auto;">
                <option value="">Todas las zonas</option>
                {% for ruta in rutas %}
                <option value="{{ ruta.nombre }}">{{ ruta.nombre }}</option>
                {% endfor %}
            </select>
            <a href="{% url 'core:exportar_planilla_excel' %}?fecha={{ fecha_hoy|date:'Y-m-d' }}" class="btn btn-sm btn-outline-success">
                <i class="bi bi-file-earmark-excel me-1"></i> Excel
            </a>
        </div>
    </div>
    
    <!-- Resumen rápido -->
    <div class="row g-2 mb-4">
        <div class="col-4">
            <div class="stat-card">
                <div class="stat-icon bg-success bg-opacity-10 text-success">
                    <i class="bi bi-cash-stack"></i>
                </div>
                <div class="stat-value text-success" id="total-cobrado-hoy">
                    {{ total_cobrado_hoy|dinero }}
                </div>
                <div class="stat-label">Cobrado</div>
            </div>
        </div>
        <div class="col-4">
            <div class="stat-card">
                <div class="stat-icon bg-warning bg-opacity-10 text-warning">
                    <i class="bi bi-clock-history"></i>
                </div>
                <div class="stat-value">{{ total_por_cobrar|dinero }}</div>
                <div class="stat-label">Por Cobrar</div>
            </div>
        </div>
        <div class="col-4">
            <div class="stat-card">
                <div class="stat-icon bg-danger bg-opacity-10 text-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
                <div class="stat-value">{{ total_vencidas|dinero }}</div>
                <div class="stat-label">Vencidas</div>
            </div>
        </div>
    </div>
    
    <!-- Accordion de secciones -->
    <div class="accordion" id="accordionCobros">
        
        <!-- Cuotas vencidas (prioritarias) -->
        {% if cuotas_vencidas %}
        <div class="accordion-item border-danger">
            <h2 class="accordion-header">
                <button class="accordion-button bg-danger bg-opacity-10 text-danger" type="button" data-bs-toggle="collapse" data-bs-target="#collapseVencidas" aria-expanded="true">
                    <i class="bi bi-exclamation-circle-fill me-2"></i>
                    <strong>Cuotas Vencidas</strong>
                    <span class="badge bg-danger ms-2">{{ cuotas_vencidas|length }}</span>
                    <span class="ms-2 small">{{ total_vencidas|dinero }}</span>
                </button>
            </h2>
            <div id="collapseVencidas" class="accordion-collapse collapse show" data-bs-parent="#accordionCobros">
                <div class="accordion-body p-2">
                    {% for cuota in cuotas_vencidas %}
                    <div class="payment-card vencida filtrable" data-zona="{{ cuota.prestamo.cliente.ruta.nombre|default:'Sin Zona' }}">
                        <div class="payment-card-header">
                            <div class="client-info">
                                <div class="client-avatar vencida">{{ cuota.prestamo.cliente.nombre|slice:":1" }}{{ cuota.prestamo.cliente.apellido|slice:":1" }}</div>
                                <div class="client-details">
                                    <h6 class="client-name">{{ cuota.prestamo.cliente.nombre_completo }}</h6>
                                    <span class="loan-progress">Cuota {{ cuota.numero_cuota }} de {{ cuota.prestamo.cuotas_pactadas }}</span>
                                </div>
                            </div>
                            <div class="amount-section vencida">
                                <span class="amount">{{ cuota.monto_restante|dinero }}</span>
                                <span class="overdue-badge">{{ cuota.dias_vencida }} días</span>
                            </div>
                        </div>
                        <div class="payment-card-body" onclick="this.parentElement.classList.toggle('expanded')">
                            <div class="info-chips">
                                {% if user.is_superuser and cuota.prestamo.cliente.usuario %}<span class="chip" style="background: #e0e7ff; color: #3730a3;"><i class="bi bi-person-badge"></i> {{ cuota.prestamo.cliente.usuario.get_full_name|default:cuota.prestamo.cliente.usuario.username }}</span>{% endif %}
                                {% if cuota.prestamo.cliente.ruta %}<span class="chip"><i class="bi bi-geo-alt"></i> {{ cuota.prestamo.cliente.ruta.nombre }}</span>{% endif %}
                                <span class="chip"><i class="bi bi-telephone"></i> {{ cuota.prestamo.cliente.telefono|default:'Sin tel.' }}</span>
                                <span class="chip"><i class="bi bi-calendar-x"></i> Fin: {{ cuota.prestamo.fecha_finalizacion|date:"d/m/Y" }}</span>
                                <span class="chip"><i class="bi bi-house-door"></i> {{ cuota.prestamo.cliente.direccion|default:'Sin dirección'|truncatechars:30 }}</span>
                                {% if cuota.interes_mora_pendiente > 0 %}<span class="chip mora"><i class="bi bi-percent"></i> +{{ cuota.interes_mora_pendiente|dinero }}</span>{% endif %}
                            </div>
                        </div>
                        <div class="payment-card-expand">
                            <div class="expand-content">
                                <p><i class="bi bi-house-door"></i> {{ cuota.prestamo.cliente.direccion|default:'Sin dirección' }}</p>
                                <a href="{% url 'core:cliente_detail' cuota.prestamo.cliente.pk %}" class="btn-link"><i class="bi bi-person-circle"></i> Ver perfil completo</a>
                            </div>
                        </div>
                        <div class="payment-card-actions">
                            <button type="button" class="action-btn-mini btn-editar-cobro"
                                    data-cuota-id="{{ cuota.pk }}"
                                    data-monto="{{ cuota.monto_restante|numero_raw }}"
                                    data-mora="{{ cuota.interes_mora_pendiente|numero_raw }}"
                                    data-cliente="{{ cuota.prestamo.cliente.nombre_completo }}"
                                    data-dias-vencida="{{ cuota.dias_vencida }}"
                                    data-fecha="{{ cuota.fecha_pago|date:'Y-m-d' }}"
                                    title="Cobro parcial">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                            <button type="button" class="action-btn-mini primary btn-cobrar" 
                                    data-cuota-id="{{ cuota.pk }}"
                                    data-monto="{{ cuota.monto_restante|numero_raw }}"
                                    data-cliente="{{ cuota.prestamo.cliente.nombre_completo }}"
                                    title="Cobrar completo">
                                <i class="bi bi-check-lg"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Cobros del día -->
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button {% if cuotas_vencidas %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapseHoy" aria-expanded="{% if not cuotas_vencidas %}true{% else %}false{% endif %}">
                    <i class="bi bi-calendar-check me-2"></i>
                    <strong>Cobros de Hoy</strong>
                    <span class="badge bg-primary ms-2">{{ cuotas_hoy|length }}</span>
                    <span class="ms-2 small">{{ total_por_cobrar|dinero }}</span>
                </button>
            </h2>
            <div id="collapseHoy" class="accordion-collapse collapse {% if not cuotas_vencidas %}show{% endif %}" data-bs-parent="#accordionCobros">
                <div class="accordion-body p-2">
                    {% if cuotas_hoy %}
                        {% for cuota in cuotas_hoy %}
                        <div class="payment-card pendiente filtrable" data-zona="{{ cuota.prestamo.cliente.ruta.nombre|default:'Sin Zona' }}">
                            <div class="payment-card-header">
                                <div class="client-info">
                                    <div class="client-avatar">{{ cuota.prestamo.cliente.nombre|slice:":1" }}{{ cuota.prestamo.cliente.apellido|slice:":1" }}</div>
                                    <div class="client-details">
                                        <h6 class="client-name">{{ cuota.prestamo.cliente.nombre_completo }}</h6>
                                        <span class="loan-progress">Cuota {{ cuota.numero_cuota }} de {{ cuota.prestamo.cuotas_pactadas }}{% if cuota.estado == 'PC' %} <span class="partial-dot"></span>{% endif %}</span>
                                    </div>
                                </div>
                                <div class="amount-section">
                                    <span class="amount">{{ cuota.monto_restante|dinero }}</span>
                                </div>
                            </div>
                            <div class="payment-card-body" onclick="this.parentElement.classList.toggle('expanded')">
                                <div class="info-chips">
                                    {% if user.is_superuser and cuota.prestamo.cliente.usuario %}<span class="chip" style="background: #e0e7ff; color: #3730a3;"><i class="bi bi-person-badge"></i> {{ cuota.prestamo.cliente.usuario.get_full_name|default:cuota.prestamo.cliente.usuario.username }}</span>{% endif %}
                                    {% if cuota.prestamo.cliente.ruta %}<span class="chip"><i class="bi bi-geo-alt"></i> {{ cuota.prestamo.cliente.ruta.nombre }}</span>{% endif %}
                                    <span class="chip"><i class="bi bi-telephone"></i> {{ cuota.prestamo.cliente.telefono|default:'Sin tel.' }}</span>
                                    <span class="chip"><i class="bi bi-calendar-check"></i> Fin: {{ cuota.prestamo.fecha_finalizacion|date:"d/m/Y" }}</span>
                                    <span class="chip"><i class="bi bi-house-door"></i> {{ cuota.prestamo.cliente.direccion|default:'Sin dirección'|truncatechars:30 }}</span>
                                </div>
                            </div>
                            <div class="payment-card-expand">
                                <div class="expand-content">
                                    <p><i class="bi bi-house-door"></i> {{ cuota.prestamo.cliente.direccion|default:'Sin dirección' }}</p>
                                    <a href="{% url 'core:cliente_detail' cuota.prestamo.cliente.pk %}" class="btn-link"><i class="bi bi-person-circle"></i> Ver perfil completo</a>
                                </div>
                            </div>
                            <div class="payment-card-actions">
                                <button type="button" class="action-btn-mini btn-editar-cobro"
                                        data-cuota-id="{{ cuota.pk }}"
                                        data-monto="{{ cuota.monto_restante|numero_raw }}"
                                        data-mora="0"
                                        data-cliente="{{ cuota.prestamo.cliente.nombre_completo }}"
                                        data-dias-vencida="0"
                                        data-fecha="{{ cuota.fecha_pago|date:'Y-m-d' }}"
                                        title="Cobro parcial">
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                                <button type="button" class="action-btn-mini primary btn-cobrar" 
                                        data-cuota-id="{{ cuota.pk }}"
                                        data-monto="{{ cuota.monto_restante|numero_raw }}"
                                        data-cliente="{{ cuota.prestamo.cliente.nombre_completo }}"
                                        title="Cobrar completo">
                                    <i class="bi bi-check-lg"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state py-4 text-center">
                            <i class="bi bi-emoji-smile fs-1 text-muted"></i>
                            <h5 class="mt-2">¡Sin cobros pendientes!</h5>
                            <p class="text-muted">No hay cuotas programadas para hoy.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Cuotas Próximas (7 días) -->
        {% if cuotas_semana %}
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseProximas" aria-expanded="false">
                    <i class="bi bi-calendar-week me-2 text-info"></i>
                    <strong>Próximos 7 días</strong>
                    <span class="badge bg-info ms-2">{{ cuotas_semana|length }}</span>
                </button>
            </h2>
            <div id="collapseProximas" class="accordion-collapse collapse" data-bs-parent="#accordionCobros">
                <div class="accordion-body p-2">
                    {% for cuota in cuotas_semana %}
                    <div class="payment-card proxima filtrable" data-zona="{{ cuota.prestamo.cliente.ruta.nombre|default:'Sin Zona' }}">
                        <div class="payment-card-header">
                            <div class="client-info">
                                <div class="client-avatar proxima">{{ cuota.prestamo.cliente.nombre|slice:":1" }}{{ cuota.prestamo.cliente.apellido|slice:":1" }}</div>
                                <div class="client-details">
                                    <h6 class="client-name">{{ cuota.prestamo.cliente.nombre_completo }}</h6>
                                    <span class="loan-progress">Cuota {{ cuota.numero_cuota }} de {{ cuota.prestamo.cuotas_pactadas }}</span>
                                </div>
                            </div>
                            <div class="amount-section proxima">
                                <span class="amount">{{ cuota.monto_restante|dinero }}</span>
                                <span class="date-badge">{{ cuota.fecha_vencimiento|date:"d/m" }}</span>
                            </div>
                        </div>
                        <div class="payment-card-body" onclick="this.parentElement.classList.toggle('expanded')">
                            <div class="info-chips">
                                {% if user.is_superuser and cuota.prestamo.cliente.usuario %}<span class="chip" style="background: #e0e7ff; color: #3730a3;"><i class="bi bi-person-badge"></i> {{ cuota.prestamo.cliente.usuario.get_full_name|default:cuota.prestamo.cliente.usuario.username }}</span>{% endif %}
                                {% if cuota.prestamo.cliente.ruta %}<span class="chip"><i class="bi bi-geo-alt"></i> {{ cuota.prestamo.cliente.ruta.nombre }}</span>{% endif %}
                                <span class="chip"><i class="bi bi-telephone"></i> {{ cuota.prestamo.cliente.telefono|default:'Sin tel.' }}</span>
                                <span class="chip"><i class="bi bi-calendar-check"></i> Fin: {{ cuota.prestamo.fecha_finalizacion|date:"d/m/Y" }}</span>
                                <span class="chip"><i class="bi bi-house-door"></i> {{ cuota.prestamo.cliente.direccion|default:'Sin dirección'|truncatechars:30 }}</span>
                            </div>
                        </div>
                        <div class="payment-card-expand">
                            <div class="expand-content">
                                <p><i class="bi bi-house-door"></i> {{ cuota.prestamo.cliente.direccion|default:'Sin dirección' }}</p>
                                <a href="{% url 'core:cliente_detail' cuota.prestamo.cliente.pk %}" class="btn-link"><i class="bi bi-person-circle"></i> Ver perfil completo</a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Cuotas del mes (8-30 días) -->
        {% if cuotas_mes %}
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMes" aria-expanded="false">
                    <i class="bi bi-calendar-month me-2 text-secondary"></i>
                    <strong>Resto del mes</strong>
                    <span class="badge bg-secondary ms-2">{{ cuotas_mes|length }}</span>
                </button>
            </h2>
            <div id="collapseMes" class="accordion-collapse collapse" data-bs-parent="#accordionCobros">
                <div class="accordion-body p-2">
                    {% for cuota in cuotas_mes %}
                    <div class="payment-card proxima filtrable" data-zona="{{ cuota.prestamo.cliente.ruta.nombre|default:'Sin Zona' }}">
                        <div class="payment-card-header">
                            <div class="client-info">
                                <div class="client-avatar" style="background: #6c757d;">{{ cuota.prestamo.cliente.nombre|slice:":1" }}{{ cuota.prestamo.cliente.apellido|slice:":1" }}</div>
                                <div class="client-details">
                                    <h6 class="client-name">{{ cuota.prestamo.cliente.nombre_completo }}</h6>
                                    <span class="loan-progress">Cuota {{ cuota.numero_cuota }} de {{ cuota.prestamo.cuotas_pactadas }}</span>
                                </div>
                            </div>
                            <div class="amount-section">
                                <span class="amount">{{ cuota.monto_restante|dinero }}</span>
                                <span class="date-badge" style="background: #e9ecef; color: #495057;">{{ cuota.fecha_vencimiento|date:"d M" }}</span>
                            </div>
                        </div>
                        <div class="payment-card-body" onclick="this.parentElement.classList.toggle('expanded')">
                            <div class="info-chips">
                                {% if user.is_superuser and cuota.prestamo.cliente.usuario %}<span class="chip" style="background: #e0e7ff; color: #3730a3;"><i class="bi bi-person-badge"></i> {{ cuota.prestamo.cliente.usuario.get_full_name|default:cuota.prestamo.cliente.usuario.username }}</span>{% endif %}
                                {% if cuota.prestamo.cliente.ruta %}<span class="chip"><i class="bi bi-geo-alt"></i> {{ cuota.prestamo.cliente.ruta.nombre }}</span>{% endif %}
                                <span class="chip"><i class="bi bi-telephone"></i> {{ cuota.prestamo.cliente.telefono|default:'Sin tel.' }}</span>
                                <span class="chip"><i class="bi bi-calendar-check"></i> Fin: {{ cuota.prestamo.fecha_finalizacion|date:"d/m/Y" }}</span>
                                <span class="chip"><i class="bi bi-house-door"></i> {{ cuota.prestamo.cliente.direccion|default:'Sin dirección'|truncatechars:30 }}</span>
                            </div>
                        </div>
                        <div class="payment-card-expand">
                            <div class="expand-content">
                                <p><i class="bi bi-house-door"></i> {{ cuota.prestamo.cliente.direccion|default:'Sin dirección' }}</p>
                                <a href="{% url 'core:cliente_detail' cuota.prestamo.cliente.pk %}" class="btn-link"><i class="bi bi-person-circle"></i> Ver perfil completo</a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
        
    </div>
    
</div>

<!-- FAB para nuevo préstamo -->
<a href="{% url 'core:prestamo_create' %}" class="fab no-print" title="Nuevo Préstamo">
    <i class="bi bi-plus-lg"></i>
</a>

<!-- Modal de confirmación de cobro rápido -->
<div class="confirm-modal-overlay" id="confirm-cobro-modal">
    <div class="confirm-modal">
        <div class="confirm-modal-header-strip">
            <div class="confirm-modal-icon">
                <i class="bi bi-cash-coin"></i>
            </div>
            <h5>Confirmar Cobro</h5>
        </div>
        <div class="confirm-modal-body">
            <div class="confirm-modal-amount" id="confirm-monto">$0</div>
            <div class="confirm-modal-client" id="confirm-cliente">
                <i class="bi bi-person-fill"></i> Cliente
            </div>
        </div>
        <input type="hidden" id="confirm-cuota-id">
        <div class="confirm-modal-actions">
            <button type="button" class="btn-cancelar" onclick="cerrarConfirmacion()">
                <i class="bi bi-x-lg"></i> Cancelar
            </button>
            <button type="button" class="btn-confirmar" onclick="ejecutarCobro()">
                <i class="bi bi-check2-circle"></i> Cobrar
            </button>
        </div>
    </div>
</div>

<!-- Modal para cobro personalizado -->
<div class="modal fade" id="modal-pago-parcial" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white py-3">
                <h5 class="modal-title">
                    <i class="bi bi-receipt me-2"></i>Cobro Personalizado
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="pago-cuota-id">
                <input type="hidden" id="pago-monto-max">
                
                <!-- Info del cliente -->
                <div class="text-center mb-3 pb-2 border-bottom">
                    <h6 class="mb-1" id="pago-cliente-nombre">Cliente</h6>
                    <div class="d-flex justify-content-center gap-3 small">
                        <span>Cuota: <strong id="pago-monto-max-label" class="text-primary">$0</strong></span>
                        <span>Fecha: <strong id="pago-fecha-cuota" class="text-primary">--</strong></span>
                    </div>
                    <div id="info-mora-container" class="mt-2" style="display: none;">
                        <span class="badge bg-danger"><i class="bi bi-exclamation-triangle me-1"></i>Vencida hace <span id="pago-dias-vencida">0</span> días</span>
                    </div>
                </div>
                
                <!-- Monto a cobrar -->
                <div class="mb-3">
                    <label class="form-label fw-semibold small">Monto a cobrar:</label>
                    <input type="text" class="form-control form-control-lg text-center" id="pago-monto" 
                           inputmode="numeric" placeholder="0"
                           oninput="formatearInputMonto(this); calcularResumenPago(); calcularInteresDesdeporcentaje()">
                </div>
                
                <!-- Calculador de Interés -->
                <div class="card bg-light mb-3">
                    <div class="card-body py-2">
                        <label class="form-label fw-semibold small mb-2">
                            <i class="bi bi-percent me-1"></i>Calcular Interés por Mora
                        </label>
                        <div class="row g-2 align-items-end">
                            <div class="col-5">
                                <label class="form-label small mb-1">% Diario:</label>
                                <input type="number" step="0.01" class="form-control form-control-sm text-center" 
                                       id="pago-porcentaje-input" value="{{ config_mora.porcentaje_diario|default:'0.5' }}"
                                       oninput="calcularInteresDesdeporcentaje()">
                            </div>
                            <div class="col-4">
                                <label class="form-label small mb-1">Días:</label>
                                <input type="number" class="form-control form-control-sm text-center" 
                                       id="pago-dias-mora-input" value="0"
                                       oninput="calcularInteresDesdeporcentaje()">
                            </div>
                            <div class="col-3">
                                <button type="button" class="btn btn-primary btn-sm w-100" onclick="aplicarInteresCalculado()">
                                    <i class="bi bi-arrow-down"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mt-2 text-center" id="interes-calculado-container">
                            <small class="text-muted">Interés calculado:</small>
                            <div class="fw-bold text-warning fs-5" id="interes-calculado-preview">$0</div>
                        </div>
                    </div>
                </div>
                
                <!-- Interés a cobrar -->
                <div class="mb-3">
                    <label class="form-label fw-semibold small">Interés por mora a cobrar:</label>
                    <input type="text" class="form-control text-center" id="pago-interes-mora" 
                           inputmode="numeric" placeholder="0"
                           oninput="formatearInputMonto(this); calcularResumenPago()">
                </div>
                
                <!-- RESUMEN DESTACADO -->
                <div class="pago-resumen mb-3">
                    <div class="pago-resumen-row">
                        <span class="label">Monto cuota:</span>
                        <span class="valor" id="resumen-monto-cuota">$0</span>
                    </div>
                    <div class="pago-resumen-row">
                        <span class="label">Vas a cobrar:</span>
                        <span class="valor" id="resumen-monto-cobrar">$0</span>
                    </div>
                    <div class="pago-resumen-row" id="resumen-mora-row" style="display: none;">
                        <span class="label">+ Interés mora:</span>
                        <span class="valor" id="resumen-mora">$0</span>
                    </div>
                    <div class="pago-resumen-row total">
                        <span class="label">TOTAL A RECIBIR:</span>
                        <span class="valor text-success" id="resumen-total">$0</span>
                    </div>
                    <div class="pago-resumen-row restante" id="resumen-restante-row" style="display: none;">
                        <span class="label"><i class="bi bi-exclamation-circle me-1"></i>QUEDA PENDIENTE:</span>
                        <span class="valor text-danger fw-bold" id="resumen-restante">$0</span>
                    </div>
                </div>
                
                <!-- Qué hacer con el restante -->
                <div class="mb-3" id="accion-restante-container" style="display: none;">
                    <label class="form-label fw-semibold small text-danger">
                        <i class="bi bi-arrow-right-circle me-1"></i>¿Qué hacer con lo pendiente?
                    </label>
                    <select class="form-select" id="pago-accion-restante" onchange="toggleFechaEspecial()">
                        <option value="ignorar">Dejar pendiente en esta cuota</option>
                        <option value="proxima">Sumar a la próxima cuota</option>
                        <option value="especial">Agendar para otra fecha</option>
                    </select>
                </div>
                
                <div class="mb-3" id="fecha-especial-container" style="display: none;">
                    <label class="form-label small">Fecha para pagar lo pendiente:</label>
                    <input type="date" class="form-control" id="pago-fecha-especial">
                </div>
                
                <!-- Método de pago -->
                <div class="mb-3">
                    <label class="form-label fw-semibold small">Método de pago:</label>
                    <select class="form-select" id="pago-metodo" onchange="toggleMetodoPago()">
                        <option value="EF">Efectivo</option>
                        <option value="TR">Transferencia</option>
                        <option value="MX">Mixto</option>
                    </select>
                </div>
                
                <div id="metodo-mixto-container" style="display: none;">
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="form-label small">Efectivo:</label>
                            <input type="text" class="form-control" id="pago-monto-efectivo" 
                                   inputmode="numeric" placeholder="0"
                                   oninput="formatearInputMonto(this); validarMontosMixtos()">
                        </div>
                        <div class="col-6">
                            <label class="form-label small">Transferencia:</label>
                            <input type="text" class="form-control" id="pago-monto-transferencia" 
                                   inputmode="numeric" placeholder="0"
                                   oninput="formatearInputMonto(this); validarMontosMixtos()">
                        </div>
                    </div>
                </div>
                
                <div id="referencia-container" style="display: none;">
                    <div class="mb-3">
                        <label class="form-label small">Referencia/Nº operación:</label>
                        <input type="text" class="form-control" id="pago-referencia" placeholder="Número de operación">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="confirmarPagoParcial()">
                    <i class="bi bi-check-lg me-1"></i>Registrar Cobro
                </button>
            </div>
        </div>
    </div>
</div>

{% csrf_token %}

<!-- Modal para cambiar categoría -->
<div class="modal fade" id="modal-categoria" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-tag me-2"></i>Cambiar Categoría
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="categoria-cliente-id">
                <p class="text-muted mb-3">Selecciona la nueva categoría:</p>
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-success btn-categoria-opcion" data-categoria="EX">
                        <i class="bi bi-star-fill me-2"></i>Excelente
                    </button>
                    <button type="button" class="btn btn-outline-warning btn-categoria-opcion" data-categoria="RE">
                        <i class="bi bi-dash-circle me-2"></i>Regular
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-categoria-opcion" data-categoria="MO">
                        <i class="bi bi-exclamation-triangle me-2"></i>Moroso
                    </button>
                    <button type="button" class="btn btn-outline-info btn-categoria-opcion" data-categoria="NU">
                        <i class="bi bi-person-plus me-2"></i>Nuevo
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ============ FILTRO POR ZONA ============
document.getElementById('filtro-zona').addEventListener('change', function() {
    const zonaSeleccionada = this.value.toLowerCase();
    document.querySelectorAll('.filtrable').forEach(card => {
        const zonaCard = (card.dataset.zona || '').toLowerCase();
        if (!zonaSeleccionada || zonaCard.includes(zonaSeleccionada)) {
            card.style.display = '';
        } else {
            card.style.display = 'none';
        }
    });
});

// ============ MÉTODO DE PAGO ============
function toggleMetodoPago() {
    const metodo = document.getElementById('pago-metodo').value;
    const mixtoContainer = document.getElementById('metodo-mixto-container');
    const referenciaContainer = document.getElementById('referencia-container');
    
    if (metodo === 'MX') {
        mixtoContainer.style.display = 'block';
        referenciaContainer.style.display = 'block';
    } else if (metodo === 'TR') {
        mixtoContainer.style.display = 'none';
        referenciaContainer.style.display = 'block';
    } else {
        mixtoContainer.style.display = 'none';
        referenciaContainer.style.display = 'none';
    }
}

function validarMontosMixtos() {
    const montoTotal = parseFloat(document.getElementById('pago-monto').value.replace(/\./g, '').replace(',', '.')) || 0;
    const montoEfectivo = parseFloat(document.getElementById('pago-monto-efectivo').value.replace(/\./g, '').replace(',', '.')) || 0;
    const montoTransferencia = parseFloat(document.getElementById('pago-monto-transferencia').value.replace(/\./g, '').replace(',', '.')) || 0;
    
    const suma = montoEfectivo + montoTransferencia;
    if (suma !== montoTotal && suma > 0) {
        document.getElementById('pago-monto-efectivo').classList.add('is-invalid');
        document.getElementById('pago-monto-transferencia').classList.add('is-invalid');
    } else {
        document.getElementById('pago-monto-efectivo').classList.remove('is-invalid');
        document.getElementById('pago-monto-transferencia').classList.remove('is-invalid');
    }
}

// ============ MODAL DE PAGO PARCIAL ============
let diasVencidaActual = 0;
let montoMaxActual = 0;
let fechaCuotaActual = '';

function showPagoParcialModal(cuotaId, monto, cliente, mora = 0, diasVencida = 0, fechaCuota = '') {
    diasVencidaActual = diasVencida;
    montoMaxActual = monto;
    fechaCuotaActual = fechaCuota;
    
    document.getElementById('pago-cuota-id').value = cuotaId;
    document.getElementById('pago-monto-max').value = monto;
    document.getElementById('pago-cliente-nombre').textContent = cliente;
    document.getElementById('pago-monto-max-label').textContent = formatearMoneda(monto);
    document.getElementById('pago-monto').value = formatearNumero(monto);
    document.getElementById('pago-accion-restante').value = 'ignorar';
    document.getElementById('pago-metodo').value = 'EF';
    document.getElementById('pago-monto-efectivo').value = '';
    document.getElementById('pago-monto-transferencia').value = '';
    document.getElementById('pago-referencia').value = '';
    document.getElementById('pago-interes-mora').value = '0';
    
    // Mostrar fecha de la cuota
    if (fechaCuota) {
        const fecha = new Date(fechaCuota + 'T00:00:00');
        const opciones = { day: '2-digit', month: 'short' };
        document.getElementById('pago-fecha-cuota').textContent = fecha.toLocaleDateString('es-ES', opciones);
    } else {
        document.getElementById('pago-fecha-cuota').textContent = 'Hoy';
    }
    
    // Configurar calculador de interés
    document.getElementById('pago-dias-mora-input').value = diasVencida;
    calcularInteresDesdeporcentaje();
    
    // Mostrar días vencidos si aplica
    const infoMoraContainer = document.getElementById('info-mora-container');
    if (diasVencida > 0) {
        infoMoraContainer.style.display = 'block';
        document.getElementById('pago-dias-vencida').textContent = diasVencida;
    } else {
        infoMoraContainer.style.display = 'none';
    }
    
    toggleFechaEspecial();
    toggleMetodoPago();
    calcularResumenPago();
    
    const modal = new bootstrap.Modal(document.getElementById('modal-pago-parcial'));
    modal.show();
}

// Calcula el interés en base al % y días ingresados - sobre el RESTANTE
function calcularInteresDesdeporcentaje() {
    const porcentaje = parseFloat(document.getElementById('pago-porcentaje-input').value) || 0;
    const dias = parseInt(document.getElementById('pago-dias-mora-input').value) || 0;
    const montoStr = document.getElementById('pago-monto').value;
    const montoCobrar = parseFloat(montoStr.replace(/\./g, '').replace(',', '.')) || 0;
    
    // Calcular sobre lo que queda pendiente
    const restante = montoMaxActual - montoCobrar;
    const baseCalculo = restante > 0 ? restante : montoMaxActual;
    
    const interes = Math.round((baseCalculo * porcentaje / 100) * dias);
    
    // Mostrar sobre qué monto se calcula
    const label = restante > 0 ? 
        `Sobre restante (${formatearMoneda(restante)})` : 
        `Sobre cuota (${formatearMoneda(montoMaxActual)})`;
    document.getElementById('interes-calculado-preview').innerHTML = 
        `${formatearMoneda(interes)}<br><small class="text-muted">${label}</small>`;
}

// Aplica el interés calculado al campo de interés
function aplicarInteresCalculado() {
    const porcentaje = parseFloat(document.getElementById('pago-porcentaje-input').value) || 0;
    const dias = parseInt(document.getElementById('pago-dias-mora-input').value) || 0;
    const montoStr = document.getElementById('pago-monto').value;
    const montoCobrar = parseFloat(montoStr.replace(/\./g, '').replace(',', '.')) || 0;
    
    const restante = montoMaxActual - montoCobrar;
    const baseCalculo = restante > 0 ? restante : montoMaxActual;
    
    const interes = Math.round((baseCalculo * porcentaje / 100) * dias);
    document.getElementById('pago-interes-mora').value = formatearNumero(interes);
    calcularResumenPago();
}

function calcularResumenPago() {
    const montoStr = document.getElementById('pago-monto').value;
    const interesMoraStr = document.getElementById('pago-interes-mora').value;
    
    const monto = parseFloat(montoStr.replace(/\./g, '').replace(',', '.')) || 0;
    const interesMora = parseFloat(interesMoraStr.replace(/\./g, '').replace(',', '.')) || 0;
    const montoMax = montoMaxActual;
    
    // Mostrar monto de cuota
    document.getElementById('resumen-monto-cuota').textContent = formatearMoneda(montoMax);
    
    // Actualizar resumen
    document.getElementById('resumen-monto-cobrar').textContent = formatearMoneda(monto);
    
    const moraRow = document.getElementById('resumen-mora-row');
    if (interesMora > 0) {
        moraRow.style.display = 'flex';
        document.getElementById('resumen-mora').textContent = formatearMoneda(interesMora);
    } else {
        moraRow.style.display = 'none';
    }
    
    const total = monto + interesMora;
    document.getElementById('resumen-total').textContent = formatearMoneda(total);
    
    // Monto restante
    const restante = montoMax - monto;
    const restanteRow = document.getElementById('resumen-restante-row');
    const accionContainer = document.getElementById('accion-restante-container');
    
    if (restante > 0) {
        restanteRow.style.display = 'flex';
        document.getElementById('resumen-restante').textContent = formatearMoneda(restante);
        accionContainer.style.display = 'block';
    } else {
        restanteRow.style.display = 'none';
        accionContainer.style.display = 'none';
    }
}

function toggleFechaEspecial() {
    const accion = document.getElementById('pago-accion-restante').value;
    document.getElementById('fecha-especial-container').style.display = 
        accion === 'especial' ? 'block' : 'none';
}

function formatearNumero(num) {
    return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

function formatearMoneda(num) {
    return '$ ' + formatearNumero(num);
}

// ============ CONFIRMACIÓN DE COBRO RÁPIDO ============
function mostrarConfirmacion(cuotaId, monto, cliente) {
    const modal = document.getElementById('confirm-cobro-modal');
    const modalInner = modal.querySelector('.confirm-modal');
    
    // Resetear estado
    modalInner.classList.remove('success');
    const headerStrip = modalInner.querySelector('.confirm-modal-header-strip');
    headerStrip.innerHTML = `
        <div class="confirm-modal-icon"><i class="bi bi-cash-coin"></i></div>
        <h5>Confirmar Cobro</h5>
    `;
    modal.querySelector('.confirm-modal-body').style.display = '';
    modal.querySelector('.confirm-modal-actions').style.display = '';
    
    document.getElementById('confirm-cuota-id').value = cuotaId;
    document.getElementById('confirm-monto').textContent = formatearMoneda(monto);
    document.getElementById('confirm-cliente').innerHTML = 
        `<i class="bi bi-person-fill"></i> ${cliente}`;
    
    // Resetear botón
    const btnConfirmar = modal.querySelector('.btn-confirmar');
    btnConfirmar.disabled = false;
    btnConfirmar.innerHTML = '<i class="bi bi-check2-circle"></i> Cobrar';
    
    modal.classList.add('show');
}

function cerrarConfirmacion() {
    document.getElementById('confirm-cobro-modal').classList.remove('show');
}

async function ejecutarCobro() {
    const cuotaId = document.getElementById('confirm-cuota-id').value;
    const modal = document.getElementById('confirm-cobro-modal');
    const btnConfirmar = modal.querySelector('.btn-confirmar');
    btnConfirmar.disabled = true;
    btnConfirmar.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Procesando...';
    
    try {
        const response = await fetch(`/api/cobrar/${cuotaId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({})
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Mostrar animación de éxito dentro del modal
            const modalInner = modal.querySelector('.confirm-modal');
            modalInner.classList.add('success');
            const headerStrip = modalInner.querySelector('.confirm-modal-header-strip');
            headerStrip.innerHTML = `
                <div class="confirm-success-check"><i class="bi bi-check-lg"></i></div>
                <div class="confirm-success-text">¡Cobro Registrado!</div>
            `;
            modalInner.querySelector('.confirm-modal-body').style.display = 'none';
            modalInner.querySelector('.confirm-modal-actions').style.display = 'none';
            
            // Ocultar la card con animación
            const card = document.querySelector(`.payment-card button[data-cuota-id="${cuotaId}"]`)?.closest('.payment-card');
            if (card) {
                card.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                card.style.opacity = '0';
                card.style.transform = 'translateX(100%)';
                card.style.maxHeight = '0';
                card.style.marginBottom = '0';
                card.style.padding = '0';
                setTimeout(() => card.remove(), 400);
            }
            
            // Actualizar estadísticas
            if (result.estadisticas) {
                document.getElementById('total-cobrado-hoy').textContent = 
                    formatearMoneda(result.estadisticas.total_cobrado_hoy);
            }
            
            // Cerrar modal con delay para mostrar éxito
            setTimeout(() => cerrarConfirmacion(), 1200);
            
        } else {
            showToast(result.message || 'Error', 'danger');
            btnConfirmar.disabled = false;
            btnConfirmar.innerHTML = '<i class="bi bi-check2-circle"></i> Cobrar';
        }
    } catch (error) {
        showToast('Error de conexión', 'danger');
        btnConfirmar.disabled = false;
        btnConfirmar.innerHTML = '<i class="bi bi-check2-circle"></i> Cobrar';
    }
}

async function confirmarPagoParcial() {
    const cuotaId = document.getElementById('pago-cuota-id').value;
    const montoStr = document.getElementById('pago-monto').value;
    const monto = parseFloat(montoStr.replace(/\./g, '').replace(',', '.')) || 0;
    const accionRestante = document.getElementById('pago-accion-restante').value;
    const fechaEspecial = document.getElementById('pago-fecha-especial').value;
    
    // Método de pago
    const metodoPago = document.getElementById('pago-metodo').value;
    const montoEfectivoStr = document.getElementById('pago-monto-efectivo').value;
    const montoTransferenciaStr = document.getElementById('pago-monto-transferencia').value;
    const montoEfectivo = parseFloat(montoEfectivoStr.replace(/\./g, '').replace(',', '.')) || 0;
    const montoTransferencia = parseFloat(montoTransferenciaStr.replace(/\./g, '').replace(',', '.')) || 0;
    const referencia = document.getElementById('pago-referencia').value;
    
    // Interés por mora
    const interesMoraStr = document.getElementById('pago-interes-mora').value;
    const interesMora = parseFloat(interesMoraStr.replace(/\./g, '').replace(',', '.')) || 0;
    
    if (monto <= 0) {
        showToast('El monto debe ser mayor a 0', 'danger');
        return;
    }
    
    // Validar montos mixtos
    if (metodoPago === 'MX' && (montoEfectivo + montoTransferencia) !== monto) {
        showToast('La suma de efectivo y transferencia debe ser igual al monto total', 'danger');
        return;
    }
    
    const data = {
        monto: monto,
        accion_restante: accionRestante,
        fecha_especial: fechaEspecial || null,
        metodo_pago: metodoPago,
        monto_efectivo: montoEfectivo,
        monto_transferencia: montoTransferencia,
        referencia_transferencia: referencia,
        interes_mora: interesMora
    };
    
    try {
        const response = await fetch(`/api/cobrar/${cuotaId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Cerrar modal de pago parcial
            const modalParcial = bootstrap.Modal.getInstance(document.getElementById('modal-pago-parcial'));
            if (modalParcial) modalParcial.hide();
            
            // Mostrar confirmación de éxito con el modal bonito
            const confirmModal = document.getElementById('confirm-cobro-modal');
            const modalInner = confirmModal.querySelector('.confirm-modal');
            modalInner.classList.add('success');
            const headerStrip = modalInner.querySelector('.confirm-modal-header-strip');
            headerStrip.innerHTML = `
                <div class="confirm-success-check"><i class="bi bi-check-lg"></i></div>
                <div class="confirm-success-text">¡Cobro Registrado!</div>
            `;
            modalInner.querySelector('.confirm-modal-body').style.display = 'none';
            modalInner.querySelector('.confirm-modal-actions').style.display = 'none';
            confirmModal.classList.add('show');
            
            // Ocultar la card de la cuota cobrada
            const card = document.querySelector(`.payment-card button[data-cuota-id="${cuotaId}"]`)?.closest('.payment-card');
            if (card) {
                card.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                card.style.opacity = '0';
                card.style.transform = 'translateX(100%)';
                card.style.maxHeight = '0';
                card.style.marginBottom = '0';
                card.style.padding = '0';
                setTimeout(() => card.remove(), 400);
            }
            
            // Actualizar estadísticas
            if (result.estadisticas) {
                document.getElementById('total-cobrado-hoy').textContent = 
                    formatearMoneda(result.estadisticas.total_cobrado_hoy);
            }
            
            // Cerrar confirmación de éxito
            setTimeout(() => cerrarConfirmacion(), 1200);
        } else {
            showToast(result.message || 'Error al registrar el cobro', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Error de conexión', 'danger');
    }
}

// Delegación de eventos para botón editar cobro
document.addEventListener('click', function(e) {
    const btn = e.target.closest('.btn-editar-cobro');
    if (btn) {
        e.preventDefault();
        e.stopPropagation();
        const cuotaId = btn.dataset.cuotaId;
        const monto = parseFloat(btn.dataset.monto);
        const cliente = btn.dataset.cliente;
        const mora = parseFloat(btn.dataset.mora || 0);
        const diasVencida = parseInt(btn.dataset.diasVencida || 0);
        const fecha = btn.dataset.fecha || '';
        showPagoParcialModal(cuotaId, monto, cliente, mora, diasVencida, fecha);
    }
});

// Delegación de eventos para botón cobrar completo - MUESTRA CONFIRMACIÓN
document.addEventListener('click', function(e) {
    const btn = e.target.closest('.btn-cobrar');
    if (!btn) return;
    
    e.preventDefault();
    e.stopPropagation();
    
    const cuotaId = btn.dataset.cuotaId;
    const monto = parseFloat(btn.dataset.monto) || 0;
    const cliente = btn.dataset.cliente || 'Cliente';
    
    mostrarConfirmacion(cuotaId, monto, cliente);
});

// Context menu y long press para abrir modal desde botón cobrar
document.addEventListener('contextmenu', function(e) {
    const btn = e.target.closest('.btn-cobrar');
    if (btn) {
        e.preventDefault();
        const card = btn.closest('.payment-card') || btn.closest('.cobro-card');
        if (card) {
            const editBtn = card.querySelector('.btn-editar-cobro');
            if (editBtn) editBtn.click();
        }
    }
});

// ============ CAMBIO DE CATEGORÍA ============
const modalCategoria = new bootstrap.Modal(document.getElementById('modal-categoria'));

// Delegación de eventos para cambio de categoría
document.addEventListener('click', function(e) {
    const btn = e.target.closest('.btn-categoria');
    if (btn) {
        e.preventDefault();
        e.stopPropagation();
        const clienteId = btn.dataset.clienteId;
        document.getElementById('categoria-cliente-id').value = clienteId;
        
        // Resaltar la categoría actual
        const categoriaActual = btn.dataset.categoria;
        document.querySelectorAll('.btn-categoria-opcion').forEach(opcion => {
            opcion.classList.remove('active');
            if (opcion.dataset.categoria === categoriaActual) {
                opcion.classList.add('active');
            }
        });
        
        modalCategoria.show();
    }
});

document.querySelectorAll('.btn-categoria-opcion').forEach(btn => {
    btn.addEventListener('click', async (e) => {
        const clienteId = document.getElementById('categoria-cliente-id').value;
        const nuevaCategoria = btn.dataset.categoria;
        
        try {
            const response = await fetch(`/api/cliente/${clienteId}/categoria/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ categoria: nuevaCategoria })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Actualizar badge en la página
                const badge = document.querySelector(`.btn-categoria[data-cliente-id="${clienteId}"]`);
                if (badge) {
                    badge.dataset.categoria = nuevaCategoria;
                    badge.textContent = data.cliente.categoria_display.slice(0, 3);
                    badge.className = 'badge btn-categoria';
                    if (nuevaCategoria === 'EX') badge.classList.add('bg-success');
                    else if (nuevaCategoria === 'RE') badge.classList.add('bg-warning', 'text-dark');
                    else if (nuevaCategoria === 'MO') badge.classList.add('bg-danger');
                    else badge.classList.add('bg-info');
                }
                
                showToast(data.message, 'success');
                modalCategoria.hide();
            } else {
                showToast(data.message || 'Error al cambiar categoría', 'danger');
            }
        } catch (error) {
            showToast('Error de conexión', 'danger');
        }
    });
});
</script>
{% endblock %}
