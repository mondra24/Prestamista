{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Nuevo Préstamo - Préstamos{% endblock %}

{% block content %}
<div class="container-fluid px-2 px-lg-4">
    
    <!-- Header -->
    <div class="d-flex align-items-center mb-4">
        <a href="{% url 'core:prestamo_list' %}" class="btn btn-outline-secondary me-3">
            <i class="bi bi-arrow-left"></i>
        </a>
        <h1 class="h4 mb-0">
            <i class="bi bi-wallet-fill me-2"></i>Nuevo Préstamo
        </h1>
    </div>
    
    <!-- Alerta de límite de crédito -->
    <div class="alert alert-info border-0 shadow-sm d-none" id="info-cliente">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <i class="bi bi-person-badge me-2"></i>
                <span id="info-cliente-nombre" class="fw-bold"></span>
                <span id="info-cliente-categoria" class="badge ms-2"></span>
            </div>
            <div class="text-end">
                <small class="text-muted">Comercio:</small>
                <span id="info-cliente-comercio" class="ms-1">-</span>
            </div>
        </div>
        <hr class="my-2">
        <div class="row text-center">
            <div class="col-4">
                <small class="text-muted d-block">Límite</small>
                <strong id="info-cliente-limite" class="text-primary">-</strong>
            </div>
            <div class="col-4">
                <small class="text-muted d-block">En uso</small>
                <strong id="info-cliente-usado" class="text-warning">-</strong>
            </div>
            <div class="col-4">
                <small class="text-muted d-block">Disponible</small>
                <strong id="info-cliente-disponible" class="text-success">-</strong>
            </div>
        </div>
        <div class="progress mt-2" style="height: 6px;">
            <div class="progress-bar" id="info-cliente-progress" role="progressbar" style="width: 0%"></div>
        </div>
    </div>
    
    <!-- Formulario -->
    <div class="card border-0 shadow-sm">
        <div class="card-body p-3 p-lg-4">
            <form method="post" novalidate>
                {% csrf_token %}
                {% crispy form %}
            </form>
        </div>
    </div>
    
</div>

<!-- Datos de clientes para JavaScript -->
<script>
const clientesData = {
    {% for cliente in clientes %}
    {{ cliente.pk }}: {
        nombre: "{{ cliente.nombre_completo }}",
        categoria: "{{ cliente.get_categoria_display }}",
        categoriaCod: "{{ cliente.categoria }}",
        comercio: "{{ cliente.tipo_comercio|default:'-' }}",
        limite: {{ cliente.limite_credito|default:0 }},
        usado: {{ cliente.credito_usado|default:0 }},
        disponible: {% if cliente.credito_disponible is not None %}{{ cliente.credito_disponible }}{% else %}null{% endif %},
        porcentaje: {{ cliente.porcentaje_credito_usado|default:0 }}
    },
    {% endfor %}
};
</script>
{% endblock %}

{% block extra_js %}
<script>
// Mostrar información del cliente seleccionado
document.addEventListener('DOMContentLoaded', function() {
    const selectCliente = document.getElementById('id_cliente');
    const infoBox = document.getElementById('info-cliente');
    
    if (selectCliente) {
        selectCliente.addEventListener('change', function() {
            const clienteId = this.value;
            if (clienteId && clientesData[clienteId]) {
                const cliente = clientesData[clienteId];
                
                document.getElementById('info-cliente-nombre').textContent = cliente.nombre;
                document.getElementById('info-cliente-comercio').textContent = cliente.comercio;
                
                // Categoría con color
                const badgeCat = document.getElementById('info-cliente-categoria');
                badgeCat.textContent = cliente.categoria;
                badgeCat.className = 'badge ms-2';
                if (cliente.categoriaCod === 'EX') badgeCat.classList.add('bg-success');
                else if (cliente.categoriaCod === 'RE') badgeCat.classList.add('bg-warning', 'text-dark');
                else if (cliente.categoriaCod === 'MO') badgeCat.classList.add('bg-danger');
                else badgeCat.classList.add('bg-info');
                
                // Límite de crédito
                if (cliente.limite > 0) {
                    document.getElementById('info-cliente-limite').textContent = '$' + cliente.limite.toLocaleString();
                    document.getElementById('info-cliente-usado').textContent = '$' + cliente.usado.toLocaleString();
                    document.getElementById('info-cliente-disponible').textContent = cliente.disponible !== null ? '$' + cliente.disponible.toLocaleString() : 'Sin límite';
                    
                    // Progress bar
                    const progress = document.getElementById('info-cliente-progress');
                    progress.style.width = cliente.porcentaje + '%';
                    progress.className = 'progress-bar';
                    if (cliente.porcentaje >= 90) progress.classList.add('bg-danger');
                    else if (cliente.porcentaje >= 70) progress.classList.add('bg-warning');
                    else progress.classList.add('bg-success');
                } else {
                    document.getElementById('info-cliente-limite').textContent = 'Sin límite';
                    document.getElementById('info-cliente-usado').textContent = '$' + cliente.usado.toLocaleString();
                    document.getElementById('info-cliente-disponible').textContent = 'Ilimitado';
                    document.getElementById('info-cliente-progress').style.width = '0%';
                }
                
                infoBox.classList.remove('d-none');
            } else {
                infoBox.classList.add('d-none');
            }
        });
        
        // Disparar evento si ya hay un cliente seleccionado
        if (selectCliente.value) {
            selectCliente.dispatchEvent(new Event('change'));
        }
    }
});
</script>
{% endblock %}
