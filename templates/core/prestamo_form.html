{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Nuevo Préstamo - Préstamos{% endblock %}

{% block content %}
<div class="container-fluid px-2 px-lg-4">
    
    <!-- Header -->
    <div class="d-flex align-items-center mb-4">
        <a href="javascript:history.back()" class="btn btn-outline-secondary me-3">
            <i class="bi bi-arrow-left"></i>
        </a>
        <h1 class="h4 mb-0">
            <i class="bi bi-wallet-fill me-2"></i>Nuevo Préstamo
        </h1>
    </div>
    
    <!-- Alerta de límite de crédito -->
    <div class="alert alert-info border-0 shadow-sm d-none" id="info-cliente">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <i class="bi bi-person-badge me-2"></i>
                <span id="info-cliente-nombre" class="fw-bold"></span>
                <span id="info-cliente-categoria" class="badge ms-2"></span>
            </div>
            <div class="text-end">
                <small class="text-muted">Negocio:</small>
                <span id="info-cliente-comercio" class="ms-1">-</span>
            </div>
        </div>
        <hr class="my-2">
        <div class="row text-center">
            <div class="col-4">
                <small class="text-muted d-block">Máx. Prestable</small>
                <strong id="info-cliente-maximo" class="text-primary">-</strong>
            </div>
            <div class="col-4">
                <small class="text-muted d-block">Deuda Actual</small>
                <strong id="info-cliente-deuda" class="text-warning">-</strong>
            </div>
            <div class="col-4">
                <small class="text-muted d-block">¿Puede Renovar?</small>
                <strong id="info-cliente-renovar" class="text-success">-</strong>
            </div>
        </div>
        <div id="info-prestamo-activo" class="mt-2 d-none">
            <hr class="my-2">
            <div class="d-flex justify-content-between align-items-center">
                <span><i class="bi bi-calendar-check me-1"></i> Préstamo activo finaliza:</span>
                <strong id="info-fecha-fin" class="text-info">-</strong>
            </div>
        </div>
        <div id="info-limite-explicacion" class="mt-2 small text-muted d-none">
            <i class="bi bi-info-circle me-1"></i>
            <span id="info-limite-texto"></span>
        </div>
    </div>
    
    <!-- Alerta de advertencia -->
    <div class="alert alert-warning border-0 shadow-sm d-none" id="alerta-credito">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <span id="alerta-credito-texto"></span>
    </div>
    
    <!-- Formulario -->
    <div class="card border-0 shadow-sm">
        <div class="card-body p-3 p-lg-4">
            <form method="post" novalidate>
                {% csrf_token %}
                {% crispy form %}
            </form>
        </div>
    </div>
    
</div>

<!-- Datos de clientes para JavaScript -->
<script>
const clientesData = {
    {% for cliente in clientes %}
    {{ cliente.pk }}: {
        nombre: "{{ cliente.nombre_completo|escapejs }}",
        categoria: "{{ cliente.get_categoria_display|escapejs }}",
        categoriaCod: "{{ cliente.categoria }}",
        tipoNegocio: "{{ cliente.tipo_negocio.nombre|default:'-'|escapejs }}",
        comercio: "{{ cliente.tipo_comercio|default:'-'|escapejs }}",
        maximoPrestable: {% if cliente.maximo_prestable is not None %}{{ cliente.maximo_prestable }}{% else %}null{% endif %},
        deudaTotal: {{ cliente.deuda_total|default:0 }},
        puedeRenovar: {{ cliente.puede_renovar|yesno:"true,false" }},
        diasParaRenovar: {{ cliente.dias_para_poder_renovar|default:0 }},
        fechaFin: "{{ cliente.fecha_fin_prestamo_activo|date:'d/m/Y'|default:'' }}",
        limitePorCategoria: {% if cliente.limite_por_categoria is not None %}{{ cliente.limite_por_categoria }}{% else %}null{% endif %},
        limiteSobreDeuda: {% if cliente.limite_sobre_deuda is not None %}{{ cliente.limite_sobre_deuda }}{% else %}null{% endif %},
        limitePorTipoNegocio: {% if cliente.limite_por_tipo_negocio is not None %}{{ cliente.limite_por_tipo_negocio }}{% else %}null{% endif %},
        limiteIndividual: {{ cliente.limite_credito|default:0 }}
    },
    {% endfor %}
};
</script>
{% endblock %}

{% block extra_js %}
<script>
// ---- Auto-calcular cuotas cuando se ponen ambas fechas + frecuencia ----
document.addEventListener('DOMContentLoaded', function() {
    const fechaInicioEl = document.getElementById('id_fecha_inicio');
    const fechaFinEl = document.getElementById('id_fecha_finalizacion');
    const frecuenciaEl = document.getElementById('id_frecuencia');
    const cuotasEl = document.getElementById('id_cuotas_pactadas');

    function calcularCuotas() {
        const fi = fechaInicioEl ? fechaInicioEl.value : '';
        const ff = fechaFinEl ? fechaFinEl.value : '';
        const freq = frecuenciaEl ? frecuenciaEl.value : '';
        if (!fi || !ff || !freq) return;

        const inicio = new Date(fi + 'T00:00:00');
        const fin = new Date(ff + 'T00:00:00');
        if (fin <= inicio) return;

        const diffMs = fin - inicio;
        const diffDias = Math.round(diffMs / 86400000);
        let cuotas = 0;

        if (freq === 'DI') {
            // Contar días hábiles (sin domingos) desde inicio hasta fin inclusive
            let d = new Date(inicio);
            // La primera cuota es el mismo día de inicio (si no es domingo)
            if (d.getDay() === 0) d.setDate(d.getDate() + 1);
            while (d <= fin) {
                if (d.getDay() !== 0) cuotas++;
                d.setDate(d.getDate() + 1);
            }
        } else if (freq === 'SE') {
            cuotas = Math.floor(diffDias / 7);
        } else if (freq === 'QU') {
            cuotas = Math.floor(diffDias / 14);
        } else if (freq === 'ME') {
            cuotas = Math.floor(diffDias / 28);
        } else if (freq === 'PU') {
            cuotas = 1;
        }

        if (cuotas > 0 && cuotasEl) {
            cuotasEl.value = cuotas;
            // Disparar input event para que se actualice el resumen
            cuotasEl.dispatchEvent(new Event('input', { bubbles: true }));
        }
    }

    if (fechaInicioEl) fechaInicioEl.addEventListener('change', calcularCuotas);
    if (fechaFinEl) fechaFinEl.addEventListener('change', calcularCuotas);
    if (frecuenciaEl) frecuenciaEl.addEventListener('change', calcularCuotas);
    
    // Lógica para Pago Único: ocultar cuotas y hacer fecha obligatoria
    if (frecuenciaEl && cuotasEl) {
        function togglePagoUnico() {
            const esPagoUnico = frecuenciaEl.value === 'PU';
            const cuotasContainer = cuotasEl.closest('.col-6') || cuotasEl.closest('.mb-3');
            
            if (esPagoUnico) {
                // Ocultar campo de cuotas y fijar en 1
                if (cuotasContainer) cuotasContainer.style.display = 'none';
                cuotasEl.value = 1;
                // Hacer fecha de finalización requerida
                if (fechaFinEl) {
                    fechaFinEl.required = true;
                    const label = fechaFinEl.closest('.mb-3')?.querySelector('label') || 
                                  fechaFinEl.closest('.col-6')?.querySelector('label');
                    if (label && !label.textContent.includes('*')) {
                        label.innerHTML += ' <span class="text-danger">*</span>';
                    }
                }
            } else {
                if (cuotasContainer) cuotasContainer.style.display = '';
                if (fechaFinEl) {
                    fechaFinEl.required = false;
                    const label = fechaFinEl.closest('.mb-3')?.querySelector('label') || 
                                  fechaFinEl.closest('.col-6')?.querySelector('label');
                    if (label) {
                        label.innerHTML = label.innerHTML.replace(/ <span class="text-danger">\*<\/span>/, '');
                    }
                }
            }
        }
        
        frecuenciaEl.addEventListener('change', togglePagoUnico);
        // Ejecutar al cargar por si ya viene seleccionado
        togglePagoUnico();
    }
});

// Mostrar información del cliente seleccionado
document.addEventListener('DOMContentLoaded', function() {
    const selectCliente = document.getElementById('id_cliente');
    const infoBox = document.getElementById('info-cliente');
    const alertaCredito = document.getElementById('alerta-credito');
    
    if (selectCliente) {
        selectCliente.addEventListener('change', function() {
            const clienteId = this.value;
            alertaCredito.classList.add('d-none');
            
            if (clienteId && clientesData[clienteId]) {
                const cliente = clientesData[clienteId];
                
                document.getElementById('info-cliente-nombre').textContent = cliente.nombre;
                
                // Tipo de negocio
                let negocioTexto = cliente.tipoNegocio;
                if (cliente.comercio !== '-' && cliente.comercio !== cliente.tipoNegocio) {
                    negocioTexto += ' - ' + cliente.comercio;
                }
                document.getElementById('info-cliente-comercio').textContent = negocioTexto;
                
                // Categoría con color
                const badgeCat = document.getElementById('info-cliente-categoria');
                badgeCat.textContent = cliente.categoria;
                badgeCat.className = 'badge ms-2';
                if (cliente.categoriaCod === 'EX') badgeCat.classList.add('bg-success');
                else if (cliente.categoriaCod === 'RE') badgeCat.classList.add('bg-warning', 'text-dark');
                else if (cliente.categoriaCod === 'MO') badgeCat.classList.add('bg-danger');
                else badgeCat.classList.add('bg-info');
                
                // Máximo prestable - usar formatNumber para formato con puntos
                if (cliente.maximoPrestable !== null) {
                    document.getElementById('info-cliente-maximo').textContent = formatCurrency(cliente.maximoPrestable);
                    document.getElementById('info-cliente-maximo').className = 'text-primary';
                } else {
                    document.getElementById('info-cliente-maximo').textContent = 'Sin límite';
                    document.getElementById('info-cliente-maximo').className = 'text-success';
                }
                
                // Deuda total - usar formatCurrency
                document.getElementById('info-cliente-deuda').textContent = formatCurrency(cliente.deudaTotal);
                if (cliente.deudaTotal > 0) {
                    document.getElementById('info-cliente-deuda').className = 'text-warning';
                } else {
                    document.getElementById('info-cliente-deuda').className = 'text-success';
                }
                
                // ¿Puede renovar?
                const renovarEl = document.getElementById('info-cliente-renovar');
                if (cliente.puedeRenovar) {
                    renovarEl.textContent = 'Sí';
                    renovarEl.className = 'text-success';
                } else {
                    if (cliente.diasParaRenovar > 0) {
                        renovarEl.textContent = 'En ' + cliente.diasParaRenovar + ' días';
                        renovarEl.className = 'text-warning';
                    } else {
                        renovarEl.textContent = 'No';
                        renovarEl.className = 'text-danger';
                    }
                }
                
                // Fecha fin préstamo activo
                const prestamoActivoDiv = document.getElementById('info-prestamo-activo');
                if (cliente.fechaFin) {
                    document.getElementById('info-fecha-fin').textContent = cliente.fechaFin;
                    prestamoActivoDiv.classList.remove('d-none');
                } else {
                    prestamoActivoDiv.classList.add('d-none');
                }
                
                // Explicación del límite - usar formatCurrency para formato correcto
                let explicacionLimite = [];
                if (cliente.limiteIndividual > 0) {
                    explicacionLimite.push('Límite individual: ' + formatCurrency(cliente.limiteIndividual));
                }
                if (cliente.limitePorCategoria !== null) {
                    explicacionLimite.push('Por categoría (' + cliente.categoria + '): ' + formatCurrency(cliente.limitePorCategoria));
                }
                if (cliente.limitePorTipoNegocio !== null) {
                    explicacionLimite.push('Por tipo negocio (' + cliente.tipoNegocio + '): ' + formatCurrency(cliente.limitePorTipoNegocio));
                }
                if (cliente.limiteSobreDeuda !== null) {
                    explicacionLimite.push('Límite sobre deuda: ' + formatCurrency(cliente.limiteSobreDeuda));
                }
                
                const explicacionDiv = document.getElementById('info-limite-explicacion');
                if (explicacionLimite.length > 0) {
                    document.getElementById('info-limite-texto').textContent = 'Límites aplicados: ' + explicacionLimite.join(' | ');
                    explicacionDiv.classList.remove('d-none');
                } else {
                    explicacionDiv.classList.add('d-none');
                }
                
                // Mostrar alerta si no puede renovar con deuda
                if (!cliente.puedeRenovar && cliente.deudaTotal > 0) {
                    document.getElementById('alerta-credito-texto').textContent = 
                        'Este cliente tiene deuda activa. Según las reglas de crédito, puede que no pueda renovar.';
                    alertaCredito.classList.remove('d-none');
                }
                
                infoBox.classList.remove('d-none');
            } else {
                infoBox.classList.add('d-none');
            }
        });
        
        // Disparar evento si ya hay un cliente seleccionado
        if (selectCliente.value) {
            selectCliente.dispatchEvent(new Event('change'));
        }
    }
});
</script>
{% endblock %}
